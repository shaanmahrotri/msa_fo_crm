<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Family Office CRM - European Investment Database</title>
    <style>
        /* CSS Custom Properties for Theming */
        :root {
            /* Default Theme - Professional Blue */
            --primary-bg: #fafbfc;
            --secondary-bg: #ffffff;
            --sidebar-bg: #1a1d29;
            --sidebar-hover: #2a2d3a;
            --border-color: #e1e5e9;
            --text-primary: #2c3e50;
            --text-secondary: #64748b;
            --text-white: #ffffff;
            --accent-blue: #3b82f6;
            --accent-blue-hover: #2563eb;
            --accent-purple: #8b5cf6;
            --success-green: #10b981;
            --warning-orange: #f59e0b;
            --error-red: #ef4444;
            --surface-hover: #f1f5f9;
            
            /* Typography */
            --font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            --font-size-base: 14px;
            --font-size-sm: 12px;
            --font-size-lg: 16px;
            --font-size-xl: 18px;
            --font-size-2xl: 24px;
            --font-size-3xl: 30px;
            
            /* Spacing */
            --spacing-xs: 0.25rem;
            --spacing-sm: 0.5rem;
            --spacing-md: 1rem;
            --spacing-lg: 1.5rem;
            --spacing-xl: 2rem;
            --spacing-2xl: 3rem;
            
            /* Border Radius */
            --radius-sm: 6px;
            --radius-md: 8px;
            --radius-lg: 12px;
            --radius-xl: 16px;
            --radius-2xl: 20px;
            
            /* Shadows */
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.1);
            --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 25px rgba(0, 0, 0, 0.1);
            --shadow-xl: 0 20px 40px rgba(0, 0, 0, 0.1);
            
            /* Layout */
            --sidebar-width: 280px;
            --header-height: auto;
            
            /* Transitions */
            --transition-base: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-family);
            background: var(--primary-bg);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
            font-size: var(--font-size-base);
        }

        .app-layout {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar Styles */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--sidebar-bg);
            border-right: 1px solid var(--border-color);
            position: fixed;
            left: 0;
            top: 0;
            height: 100vh;
            overflow-y: auto;
            z-index: 100;
            transition: var(--transition-base);
        }

        .sidebar-header {
            padding: var(--spacing-lg);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .sidebar-logo {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-md);
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: var(--accent-blue);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }

        .logo-text {
            color: var(--text-white);
            font-size: 1.25rem;
            font-weight: 600;
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            padding: var(--spacing-md);
            background: rgba(255, 255, 255, 0.05);
            border-radius: var(--radius-md);
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--accent-purple);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.875rem;
            color: white;
        }

        .user-info h4 {
            color: var(--text-white);
            font-size: 0.875rem;
            font-weight: 500;
            margin: 0;
        }

        .user-info p {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.75rem;
            margin: 0;
        }

        /* Sidebar Navigation */
        .sidebar-nav {
            padding: var(--spacing-md) 0;
        }

        .nav-section {
            margin-bottom: var(--spacing-xl);
        }

        .nav-section-title {
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            padding: 0 var(--spacing-lg);
            margin-bottom: var(--spacing-md);
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            padding: var(--spacing-md) var(--spacing-lg);
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            transition: var(--transition-base);
            border-left: 3px solid transparent;
            cursor: pointer;
        }

        .nav-item:hover {
            background: var(--sidebar-hover);
            color: var(--text-white);
        }

        .nav-item.active {
            background: var(--sidebar-hover);
            color: var(--text-white);
            border-left-color: var(--accent-blue);
        }

        .nav-item-icon {
            font-size: 1rem;
            width: 20px;
            text-align: center;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            min-height: 100vh;
            transition: var(--transition-base);
        }

        .content-header {
            background: var(--secondary-bg);
            border-bottom: 1px solid var(--border-color);
            padding: var(--spacing-lg) var(--spacing-xl);
            position: sticky;
            top: 0;
            z-index: 50;
        }

        .content-header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-md);
            flex-wrap: wrap;
            gap: var(--spacing-lg);
        }

        .page-title {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--text-primary);
            margin: 0;
        }

        .page-subtitle {
            color: var(--text-secondary);
            font-size: 0.875rem;
            margin: 0;
        }

        .header-actions {
            display: flex;
            gap: var(--spacing-md);
            align-items: center;
        }

        /* Content Body */
        .content-body {
            padding: var(--spacing-xl);
        }

        /* Button Styles */
        .btn {
            padding: 0.625rem 1.25rem;
            border: none;
            border-radius: var(--radius-md);
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition-base);
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-sm);
            text-decoration: none;
            border: 1px solid transparent;
            white-space: nowrap;
            font-family: inherit;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        .btn-primary {
            background: var(--accent-blue);
            color: white;
            box-shadow: var(--shadow-sm);
        }

        .btn-primary:hover:not(:disabled) {
            background: var(--accent-blue-hover);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: var(--secondary-bg);
            color: var(--text-primary);
            border-color: var(--border-color);
            box-shadow: var(--shadow-sm);
        }

        .btn-secondary:hover:not(:disabled) {
            background: var(--surface-hover);
            border-color: var(--text-secondary);
            transform: translateY(-1px);
        }

        .btn-success {
            background: var(--success-green);
            color: white;
            box-shadow: var(--shadow-sm);
        }

        .btn-success:hover:not(:disabled) {
            background: #059669;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
            transform: translateY(-1px);
        }

        .btn-outline {
            background: transparent;
            color: var(--accent-blue);
            border-color: var(--accent-blue);
        }

        .btn-outline:hover:not(:disabled) {
            background: var(--accent-blue);
            color: white;
        }

        /* Search Section */
        .search-section {
            background: var(--secondary-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: var(--spacing-xl);
            margin-bottom: var(--spacing-xl);
            box-shadow: var(--shadow-sm);
        }

        .search-section h3 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: var(--spacing-lg);
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .search-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: var(--spacing-lg);
            margin-bottom: var(--spacing-xl);
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-sm);
        }

        .form-group label {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-primary);
        }

        .form-group input,
        .form-group select {
            padding: 0.75rem 1rem;
            background: var(--secondary-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-size: 0.875rem;
            transition: var(--transition-base);
            box-shadow: var(--shadow-sm);
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        /* Cards Grid */
        .results-section {
            margin-top: var(--spacing-xl);
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-lg);
        }

        .results-count {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .investor-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
            gap: var(--spacing-lg);
        }

        .investor-card {
            background: var(--secondary-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-xl);
            padding: var(--spacing-lg);
            transition: var(--transition-base);
            position: relative;
            overflow: hidden;
            box-shadow: var(--shadow-sm);
        }

        .investor-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--accent-blue), var(--accent-purple));
        }

        .investor-card:hover {
            border-color: var(--accent-blue);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.15);
            transform: translateY(-4px);
        }

        /* Login Modal */
        .login-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .login-form {
            background: white;
            padding: 40px;
            border-radius: var(--radius-2xl);
            width: 90%;
            max-width: 400px;
            text-align: center;
            box-shadow: var(--shadow-xl);
        }

        .login-form h2 {
            color: var(--text-primary);
            margin-bottom: 30px;
            font-size: 1.8em;
        }

        /* Theme Control Panel */
        .theme-panel {
            position: fixed;
            top: 0;
            right: -400px;
            width: 400px;
            height: 100vh;
            background: var(--secondary-bg);
            border-left: 1px solid var(--border-color);
            box-shadow: var(--shadow-xl);
            z-index: 1000;
            transition: right 0.3s ease;
            overflow-y: auto;
        }

        .theme-panel.open {
            right: 0;
        }

        .theme-panel-header {
            padding: var(--spacing-lg);
            border-bottom: 1px solid var(--border-color);
            background: var(--accent-blue);
            color: white;
        }

        .theme-panel-title {
            font-size: var(--font-size-xl);
            font-weight: 600;
            margin: 0;
        }

        .theme-panel-body {
            padding: var(--spacing-lg);
        }

        .preset-themes {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-lg);
        }

        .preset-theme {
            padding: var(--spacing-sm);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            cursor: pointer;
            text-align: center;
            font-size: var(--font-size-sm);
            transition: var(--transition-base);
        }

        .preset-theme:hover {
            border-color: var(--accent-blue);
            background: var(--surface-hover);
        }

        /* Modal Base Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1001;
            padding: 20px;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: var(--radius-2xl);
            width: 90%;
            max-width: 900px;
            max-height: 85vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: var(--shadow-xl);
            position: relative;
        }

        .modal-header {
            padding: var(--spacing-lg);
            border-bottom: 2px solid var(--border-color);
            background: #f8f9fa;
            flex-shrink: 0;
        }

        .modal-header h3 {
            color: var(--text-primary);
            margin-bottom: 5px;
            font-size: 1.4em;
        }

        .modal-body {
            flex: 1;
            overflow-y: auto;
            padding: var(--spacing-lg);
        }

        .close-modal {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: #666;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition-base);
            z-index: 10;
        }

        .close-modal:hover {
            background: #f0f0f0;
            color: #333;
        }

        /* Status Messages */
        .status-message {
            padding: 15px;
            border-radius: var(--radius-md);
            margin-bottom: 20px;
            font-weight: 600;
            text-align: center;
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            border-left: 4px solid;
        }

        .status-success {
            background: rgba(16, 185, 129, 0.1);
            border-left-color: var(--success-green);
            color: #065f46;
        }

        .status-error {
            background: rgba(239, 68, 68, 0.1);
            border-left-color: var(--error-red);
            color: #991b1b;
        }

        .status-info {
            background: rgba(59, 130, 246, 0.1);
            border-left-color: var(--accent-blue);
            color: #1e40af;
        }

        .status-warning {
            background: rgba(245, 158, 11, 0.1);
            border-left-color: var(--warning-orange);
            color: #92400e;
        }

        /* Mobile Responsive */
        @media (max-width: 1024px) {
            .sidebar {
                transform: translateX(-100%);
            }

            .main-content {
                margin-left: 0;
            }

            .theme-panel {
                width: 100%;
                right: -100%;
            }

            .search-grid {
                grid-template-columns: 1fr;
            }

            .investor-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .content-body {
                padding: var(--spacing-md);
            }

            .content-header {
                padding: var(--spacing-md);
            }

            .search-section {
                padding: var(--spacing-lg);
            }

            .modal-content {
                width: 95%;
                max-height: 90vh;
            }
        }

        /* Hamburger Menu for Mobile */
        .mobile-menu-toggle {
            display: none;
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 101;
            background: var(--accent-blue);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            padding: 10px;
            cursor: pointer;
            box-shadow: var(--shadow-md);
        }

        @media (max-width: 1024px) {
            .mobile-menu-toggle {
                display: block;
            }

            .sidebar.mobile-open {
                transform: translateX(0);
            }

            .sidebar-overlay {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                z-index: 99;
                display: none;
            }

            .sidebar-overlay.show {
                display: block;
            }
        }

        /* Loading Animation */
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }

        .loading::after {
            content: '⏳';
            font-size: 2em;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Add Entry Form Styles - RESTORED FROM ORIGINAL */
        .progress-bar {
            height: 4px;
            background: #ecf0f1;
            margin: 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3498db, #2ecc71);
            width: 20%;
            transition: width 0.3s ease;
        }

        .section {
            margin-bottom: 40px;
            opacity: 0;
            transform: translateY(20px);
            animation: fadeInUp 0.6s ease forwards;
        }

        .section.hidden {
            display: none;
        }

        .section-title {
            font-size: 1.5rem;
            color: var(--text-primary);
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--accent-blue);
            display: flex;
            align-items: center;
        }

        .section-number {
            background: var(--accent-blue);
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-weight: bold;
        }

        .field-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .field {
            margin-bottom: 20px;
        }

        .field.full-width {
            grid-column: 1 / -1;
        }

        .field label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .required {
            color: var(--error-red);
        }

        .field input,
        .field select,
        .field textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--border-color);
            border-radius: var(--radius-md);
            font-size: 16px;
            transition: var(--transition-base);
            background: #f8f9fa;
        }

        .field input:focus,
        .field select:focus,
        .field textarea:focus {
            outline: none;
            border-color: var(--accent-blue);
            background: white;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .field textarea {
            resize: vertical;
            min-height: 100px;
        }

        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            padding: 8px;
            border-radius: var(--radius-sm);
            transition: background 0.2s ease;
        }

        .checkbox-item:hover {
            background: #f8f9fa;
        }

        .checkbox-item input[type="checkbox"] {
            width: auto;
            margin-right: 8px;
        }

        .error-message {
            background: var(--error-red);
            color: white;
            padding: 15px;
            border-radius: var(--radius-md);
            margin: 15px 0;
            display: none;
        }

        .success-message {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            color: white;
            padding: 40px;
            text-align: center;
            border-radius: var(--radius-lg);
            margin: 20px 0;
        }

        .success-message h3 {
            font-size: 1.8rem;
            margin-bottom: 15px;
        }

        /* Test Section for Add Entry */
        .test-section {
            background: #f39c12;
            color: white;
            padding: 15px;
            border-radius: var(--radius-md);
            margin: 15px 0;
        }

        .test-section button {
            background: white;
            color: #f39c12;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }

        .debug-info {
            background: #34495e;
            color: white;
            padding: 15px;
            border-radius: var(--radius-md);
            margin: 15px 0;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }

        @keyframes fadeInUp {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Additional Investor Card Styles */
        .investor-name {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--text-primary);
            padding-right: 4rem;
            line-height: 1.4;
        }

        .investor-detail {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
        }

        .investor-detail strong {
            color: var(--text-secondary);
            font-size: 0.875rem;
            min-width: 85px;
            flex-shrink: 0;
            font-weight: 500;
        }

        .investor-detail span {
            color: var(--text-primary);
            font-size: 0.875rem;
            line-height: 1.5;
        }

        .investor-detail a {
            color: var(--accent-blue);
            text-decoration: none;
            font-weight: 500;
        }

        .investor-detail a:hover {
            text-decoration: underline;
        }

        /* Tags */
        .tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .tag {
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            color: white;
            padding: 0.375rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        /* Notes Button */
        .notes-button {
            position: absolute;
            top: 1.5rem;
            right: 1.5rem;
            background: var(--accent-blue);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            padding: 0.5rem 0.75rem;
            font-size: 0.75rem;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition-base);
            display: flex;
            align-items: center;
            gap: 0.375rem;
            box-shadow: 0 2px 4px rgba(59, 130, 246, 0.3);
        }

        .notes-button:hover {
            background: var(--accent-blue-hover);
            transform: scale(1.05);
            box-shadow: 0 4px 8px rgba(59, 130, 246, 0.4);
        }

        .notes-count {
            background: rgba(255, 255, 255, 0.25);
            padding: 0.125rem 0.375rem;
            border-radius: 10px;
            font-size: 0.625rem;
            font-weight: 600;
        }

        /* Contacts Section */
        .contacts-section {
            margin-top: 1.5rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border-color);
        }

        .contacts-section > strong {
            color: var(--text-secondary);
            font-size: 0.875rem;
            font-weight: 500;
        }

        .contacts-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-top: 0.75rem;
        }

        .contact {
            background: var(--primary-bg);
            padding: 0.75rem;
            border-radius: var(--radius-md);
            border: 1px solid var(--border-color);
            transition: var(--transition-base);
        }

        .contact:hover {
            background: var(--surface-hover);
        }

        .contact-name {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
            font-size: 0.875rem;
        }

        .contact-detail {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-bottom: 0.125rem;
        }

        /* Pagination Controls */
        .pagination-controls {
            background: var(--secondary-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            margin: var(--spacing-xl) 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
            box-shadow: var(--shadow-sm);
        }

        .pagination-info {
            color: var(--text-secondary);
            font-size: 0.875rem;
            font-weight: 500;
        }

        .pagination-buttons {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .pagination-buttons button {
            padding: 0.5rem 0.75rem;
            background: var(--secondary-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            color: var(--text-primary);
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition-base);
        }

        .pagination-buttons button:hover:not(:disabled) {
            background: var(--accent-blue);
            border-color: var(--accent-blue);
            color: white;
            transform: translateY(-1px);
        }

        .pagination-buttons button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination-buttons button.active {
            background: var(--accent-blue);
            border-color: var(--accent-blue);
            color: white;
        }

        /* Page content display */
        .page-content {
            display: none;
        }

        .page-content.active {
            display: block;
        }

        /* Security Alert */
        .security-alert {
            background: #f8d7da;
            border: 2px solid #dc3545;
            border-radius: var(--radius-md);
            padding: 20px;
            margin-bottom: 20px;
            color: #721c24;
        }

        .security-alert h4 {
            margin-bottom: 10px;
            color: #dc3545;
        }

        /* Button Group */
        .button-group {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        /* Loading Button State */
        .btn-loading::after {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            margin: auto;
            border: 2px solid transparent;
            border-top-color: #ffffff;
            border-radius: 50%;
            animation: button-loading-spinner 1s ease infinite;
            left: 0;
            right: 0;
            top: 0;
            bottom: 0;
        }

        @keyframes button-loading-spinner {
            from { transform: rotate(0turn); }
            to { transform: rotate(1turn); }
        }

        /* User info styles */
        .user-info-header {
            display: flex;
            align-items: center;
            gap: 15px;
            color: var(--text-primary);
            font-weight: 600;
            flex-wrap: wrap;
        }

        .user-details {
            display: flex;
            flex-direction: column;
            min-width: 120px;
        }

        .session-info {
            font-size: 0.7em;
            color: #666;
            margin-top: 2px;
        }

        .user-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        /* Notes Overview Styles */
        .note-card {
            background: var(--secondary-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            margin-bottom: var(--spacing-lg);
            transition: var(--transition-base);
        }

        .note-card:hover {
            border-color: var(--accent-blue);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
        }

        .note-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-md);
            flex-wrap: wrap;
            gap: var(--spacing-sm);
        }

        .note-meta {
            display: flex;
            gap: var(--spacing-md);
            align-items: center;
            font-size: 0.85em;
            color: var(--text-secondary);
            flex-wrap: wrap;
        }

        .note-type-badge {
            background: var(--text-primary);
            color: white;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: 600;
        }

        .note-deal-badge {
            background: var(--accent-blue);
            color: white;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: 600;
        }

        .note-content {
            color: var(--text-primary);
            line-height: 1.5;
            background: var(--primary-bg);
            padding: var(--spacing-md);
            border-radius: var(--radius-md);
        }
    </style>
</head>
<body>
    <!-- Mobile Menu Toggle -->
    <button class="mobile-menu-toggle" onclick="toggleMobileMenu()">☰</button>
    <div class="sidebar-overlay" onclick="toggleMobileMenu()"></div>

    <!-- Theme Control Panel -->
    <div class="theme-panel" id="themePanel">
        <div class="theme-panel-header">
            <h2 class="theme-panel-title">🎨 Theme Customizer</h2>
            <p style="font-size: 0.875rem; opacity: 0.9; margin: 0;">Customize your CRM appearance</p>
        </div>
        
        <div class="theme-panel-body">
            <!-- Preset Themes -->
            <div class="theme-section">
                <h3 style="font-size: 1.125rem; margin-bottom: 1rem;">🎯 Quick Themes</h3>
                <div class="preset-themes">
                    <div class="preset-theme" onclick="applyPresetTheme('default')">
                        🔵 Default Blue
                    </div>
                    <div class="preset-theme" onclick="applyPresetTheme('purple')">
                        🟣 Royal Purple
                    </div>
                    <div class="preset-theme" onclick="applyPresetTheme('green')">
                        🟢 Success Green
                    </div>
                    <div class="preset-theme" onclick="applyPresetTheme('orange')">
                        🟠 Energy Orange
                    </div>
                    <div class="preset-theme" onclick="applyPresetTheme('dark')">
                        ⚫ Dark Mode
                    </div>
                    <div class="preset-theme" onclick="applyPresetTheme('minimal')">
                        ⚪ Minimal
                    </div>
                </div>
            </div>

            <!-- Color Settings -->
            <div class="theme-section">
                <h3 style="font-size: 1.125rem; margin-bottom: 1rem;">🎨 Colors</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label>Primary Accent</label>
                        <input type="color" id="accentPrimary" value="#3b82f6" onchange="updateColors()">
                    </div>
                    <div class="form-group">
                        <label>Secondary Accent</label>
                        <input type="color" id="accentSecondary" value="#8b5cf6" onchange="updateColors()">
                    </div>
                    <div class="form-group">
                        <label>Sidebar Background</label>
                        <input type="color" id="sidebarBg" value="#1a1d29" onchange="updateColors()">
                    </div>
                    <div class="form-group">
                        <label>Main Background</label>
                        <input type="color" id="primaryBg" value="#fafbfc" onchange="updateColors()">
                    </div>
                </div>
            </div>

            <!-- Actions -->
            <div class="button-group" style="margin-top: 2rem;">
                <button class="btn btn-primary" onclick="saveTheme()">💾 Save Theme</button>
                <button class="btn btn-secondary" onclick="resetTheme()">🔄 Reset</button>
            </div>
        </div>
    </div>

    <!-- Login Modal -->
    <div class="login-modal" id="loginModal">
        <div class="login-form">
            <h2>🔐 Secure Family Office CRM</h2>
            <p style="color: #666; margin-bottom: 30px;">Please sign in to continue</p>
            
            <div class="form-group">
                <label for="loginEmail" style="text-align: left;">Email Address</label>
                <input type="email" id="loginEmail" placeholder="Enter your email" required autocomplete="email">
            </div>
            
            <div class="form-group">
                <label for="loginPassword" style="text-align: left;">Password</label>
                <input type="password" id="loginPassword" placeholder="Enter your password" required autocomplete="current-password">
            </div>
            
            <div style="margin-top: 30px;">
                <button class="btn btn-primary" id="loginButton" onclick="login()" style="width: 100%;">
                    <span id="loginButtonText">Sign In</span>
                </button>
            </div>
            
            <div id="loginError" style="color: #dc3545; margin-top: 15px; font-size: 0.9em;"></div>
            
            <div style="margin-top: 20px; font-size: 0.8em; color: #666;">
                <p>🔒 Your connection is secured with enterprise-grade encryption</p>
            </div>
        </div>
    </div>

    <!-- Main Application -->
    <div class="app-layout" id="mainApp" style="display: none;">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">
                    <div class="logo-icon">🏛️</div>
                    <div class="logo-text">Family Office CRM</div>
                </div>
                
                <div class="user-profile">
                    <div class="user-avatar" id="userAvatar">U</div>
                    <div class="user-info">
                        <h4 id="userName">User</h4>
                        <p id="userRole">Role</p>
                    </div>
                </div>
            </div>

            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">Core Modules</div>
                    <a class="nav-item active" onclick="showPage('dashboard')">
                        <span class="nav-item-icon">📊</span>
                        Dashboard
                    </a>
                    <a class="nav-item" onclick="showPage('add-entry')">
                        <span class="nav-item-icon">➕</span>
                        Add Entry
                    </a>
                    <a class="nav-item" onclick="showPage('notes')">
                        <span class="nav-item-icon">📝</span>
                        Notes
                    </a>
                    <a class="nav-item" onclick="showUserManagement()">
                        <span class="nav-item-icon">👥</span>
                        User Management
                    </a>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">Settings</div>
                    <a class="nav-item" onclick="toggleThemePanel()">
                        <span class="nav-item-icon">🎨</span>
                        Themes
                    </a>
                    <a class="nav-item" onclick="testAPIConnection()">
                        <span class="nav-item-icon">🔧</span>
                        Test API
                    </a>
                    <a class="nav-item" onclick="changePassword()">
                        <span class="nav-item-icon">🔑</span>
                        Change Password
                    </a>
                    <a class="nav-item" onclick="logout()">
                        <span class="nav-item-icon">🚪</span>
                        Logout
                    </a>
                </div>
            </nav>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Dashboard Page -->
            <div id="dashboard-page" class="page-content active">
                <div class="content-header">
                    <div class="content-header-top">
                        <div>
                            <h1 class="page-title">Family Office Database</h1>
                            <p class="page-subtitle">Manage and track European family office relationships</p>
                        </div>
                        <div class="header-actions">
                            <div class="user-info-header">
                                <div class="user-details">
                                    <div id="headerUserName" style="font-size: 0.875rem;">User</div>
                                    <div class="session-info" id="sessionInfo">Session active</div>
                                </div>
                            </div>
                            <button class="btn btn-secondary" onclick="refreshData()">🔄 Refresh</button>
                            <button class="btn btn-primary" onclick="showPage('add-entry')">➕ Add Entry</button>
                        </div>
                    </div>
                </div>

                <div class="content-body">
                    <!-- Security Alert (for development) -->
                    <div class="security-alert" id="securityAlert">
                        <h4>🚨 SECURITY NOTICE - DEVELOPMENT VERSION</h4>
                        <p><strong>This is a development version with security limitations. Before going live, implement:</strong></p>
                        <ul style="margin-left: 20px;">
                            <li>Server-side password hashing (bcrypt/scrypt)</li>
                            <li>JWT tokens or proper session management</li>
                            <li>Rate limiting on login attempts</li>
                            <li>HTTPS enforcement</li>
                            <li>Environment variables for API URLs</li>
                            <li>Input validation and sanitization</li>
                        </ul>
                        <button class="btn btn-secondary" onclick="hideSecurityAlert()" style="margin-top: 10px; font-size: 0.8em;">
                            I understand - Hide Alert
                        </button>
                    </div>

                    <!-- Search Section -->
                    <div class="search-section">
                        <h3>🔍 Search Family Offices</h3>
                        
                        <div class="search-grid">
                            <div class="form-group">
                                <label>Family Office Name</label>
                                <input type="text" id="searchName" placeholder="Enter name...">
                            </div>
                            
                            <div class="form-group">
                                <label>Country</label>
                                <select id="searchCountry">
                                    <option value="">All Countries</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label>Industry</label>
                                <select id="searchIndustry">
                                    <option value="">All Industries</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label>Investment Stage</label>
                                <select id="searchStage">
                                    <option value="">All Stages</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label>Owner</label>
                                <select id="searchOwner">
                                    <option value="">All Owners</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label>Deal Name</label>
                                <select id="searchDeal">
                                    <option value="">All Deals</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="button-group">
                            <button class="btn btn-primary" onclick="searchInvestors()">🔍 Search</button>
                            <button class="btn btn-secondary" onclick="clearSearch()">Clear</button>
                            <button class="btn btn-secondary" onclick="refreshData()">🔄 Refresh Data</button>
                        </div>
                    </div>

                    <!-- Status Messages -->
                    <div id="statusMessage"></div>

                    <!-- Results Section -->
                    <div class="results-section">
                        <div class="results-header">
                            <div class="results-count" id="resultsCount">Loading family offices...</div>
                        </div>
                        
                        <!-- Pagination Controls Top -->
                        <div class="pagination-controls" id="topPagination">
                            <div class="pagination-info" id="paginationInfo">
                                Showing 1-30 of 0 results
                            </div>
                            <div class="pagination-buttons" id="paginationButtons">
                                <button onclick="goToPage(1)" disabled>First</button>
                                <button onclick="previousPage()" disabled>Previous</button>
                                <span id="pageNumbers"></span>
                                <button onclick="nextPage()" disabled>Next</button>
                                <button onclick="goToPage('last')" disabled>Last</button>
                            </div>
                        </div>
                        
                        <div id="loadingIndicator" class="loading" style="display: none;">Loading family offices</div>
                        
                        <div class="investor-grid" id="investorGrid">
                            <!-- Results will be populated here -->
                        </div>
                        
                        <div class="pagination-controls" id="bottomPagination" style="margin-top: 20px;">
                            <!-- Pagination controls will be cloned here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Add Entry Page - FULLY RESTORED FROM ORIGINAL -->
            <div id="add-entry-page" class="page-content">
                <div class="content-header">
                    <div class="content-header-top">
                        <div>
                            <h1 class="page-title">Marshall Street Advisors - Family Office Entry</h1>
                            <p class="page-subtitle">Add a new family office to the database</p>
                        </div>
                        <div class="header-actions">
                            <button class="btn btn-secondary" onclick="showPage('dashboard')">← Back to Dashboard</button>
                        </div>
                    </div>
                </div>
                
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>

                <div class="content-body">
                    <!-- Test Section for Debugging -->
                    <div class="test-section" id="testSection">
                        <strong>🧪 Debug Tools:</strong><br>
                        <button onclick="testConnection()">Test Connection</button>
                        <button onclick="testFormData()">Test Form Data</button>
                        <button onclick="clearDebugLog()">Clear Log</button>
                        <button onclick="toggleTestSection()">Hide Tests</button>
                    </div>

                    <!-- Debug Info Panel -->
                    <div class="debug-info" id="debugInfo">
                        <strong>Debug Log:</strong><br>
                        <span id="debugContent">Form loaded successfully</span>
                    </div>
                    
                    <div class="search-section">
                        <form id="familyOfficeForm">
                            <!-- Section 1: Basic Information -->
                            <div class="section" id="section1">
                                <div class="section-title">
                                    <span class="section-number">1</span>
                                    Basic Information
                                </div>
                                
                                <div class="field-group">
                                    <div class="field full-width">
                                        <label for="investor">Family Office/Investor Name <span class="required">*</span></label>
                                        <input type="text" id="investor" name="investor" required>
                                    </div>
                                </div>
                                
                                <div class="field-group">
                                    <div class="field">
                                        <label for="domain">Website/Domain</label>
                                        <input type="url" id="domain" name="domain" placeholder="https://example.com">
                                    </div>
                                    <div class="field">
                                        <label for="msaUser">MSA User (Your Initials) <span class="required">*</span></label>
                                        <input type="text" id="msaUser" name="msaUser" maxlength="5" required>
                                    </div>
                                </div>
                                
                                <div class="field-group">
                                    <div class="field">
                                        <label for="mainCountry">Main Country <span class="required">*</span></label>
                                        <select id="mainCountry" name="mainCountry" required>
                                            <option value="">Select a country</option>
                                            <option value="Austria">Austria</option>
                                            <option value="Belgium">Belgium</option>
                                            <option value="Denmark">Denmark</option>
                                            <option value="Finland">Finland</option>
                                            <option value="France">France</option>
                                            <option value="Germany">Germany</option>
                                            <option value="Ireland">Ireland</option>
                                            <option value="Netherlands">Netherlands</option>
                                            <option value="Norway">Norway</option>
                                            <option value="Portugal">Portugal</option>
                                            <option value="Sweden">Sweden</option>
                                            <option value="Switzerland">Switzerland</option>
                                            <option value="United Kingdom">United Kingdom</option>
                                        </select>
                                    </div>
                                    <div class="field">
                                        <label for="mainCity">Main City <span class="required">*</span></label>
                                        <input type="text" id="mainCity" name="mainCity" required>
                                    </div>
                                </div>

                                <div class="field-group">
                                    <div class="field">
                                        <label for="secondCountry">Second Country (if applicable)</label>
                                        <select id="secondCountry" name="secondCountry">
                                            <option value="">Select a country</option>
                                            <option value="Austria">Austria</option>
                                            <option value="Belgium">Belgium</option>
                                            <option value="Denmark">Denmark</option>
                                            <option value="Finland">Finland</option>
                                            <option value="France">France</option>
                                            <option value="Germany">Germany</option>
                                            <option value="Ireland">Ireland</option>
                                            <option value="Netherlands">Netherlands</option>
                                            <option value="Norway">Norway</option>
                                            <option value="Portugal">Portugal</option>
                                            <option value="Sweden">Sweden</option>
                                            <option value="Switzerland">Switzerland</option>
                                            <option value="United Kingdom">United Kingdom</option>
                                        </select>
                                    </div>
                                    <div class="field">
                                        <label for="secondCity">Second City (if applicable)</label>
                                        <input type="text" id="secondCity" name="secondCity">
                                    </div>
                                </div>
                            </div>

                            <!-- Section 2: Investment Focus -->
                            <div class="section hidden" id="section2">
                                <div class="section-title">
                                    <span class="section-number">2</span>
                                    Investment Focus
                                </div>
                                
                                <div class="field">
                                    <label for="investorCategory">Investor Category</label>
                                    <select id="investorCategory" name="investorCategory">
                                        <option value="">Select category</option>
                                        <option value="Family Office">Family Office</option>
                                        <option value="Single Family Office">Single Family Office</option>
                                        <option value="Multi Family Office">Multi Family Office</option>
                                        <option value="Private Wealth">Private Wealth</option>
                                        <option value="Investment Office">Investment Office</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>
                                
                                <div class="field">
                                    <label>Industries <span class="required">*</span></label>
                                    <div class="checkbox-group">
                                        <div class="checkbox-item">
                                            <input type="checkbox" id="agtech" name="industries" value="AgTech">
                                            <label for="agtech">AgTech</label>
                                        </div>
                                        <div class="checkbox-item">
                                            <input type="checkbox" id="consumer" name="industries" value="Consumer Goods">
                                            <label for="consumer">Consumer Goods</label>
                                        </div>
                                        <div class="checkbox-item">
                                            <input type="checkbox" id="education" name="industries" value="Education">
                                            <label for="education">Education</label>
                                        </div>
                                        <div class="checkbox-item">
                                            <input type="checkbox" id="financial" name="industries" value="Financial Services">
                                            <label for="financial">Financial Services</label>
                                        </div>
                                        <div class="checkbox-item">
                                            <input type="checkbox" id="healthcare" name="industries" value="Healthcare">
                                            <label for="healthcare">Healthcare</label>
                                        </div>
                                        <div class="checkbox-item">
                                            <input type="checkbox" id="internet" name="industries" value="Internet Services">
                                            <label for="internet">Internet Services</label>
                                        </div>
                                        <div class="checkbox-item">
                                            <input type="checkbox" id="payments" name="industries" value="Payments">
                                            <label for="payments">Payments</label>
                                        </div>
                                        <div class="checkbox-item">
                                            <input type="checkbox" id="platforms" name="industries" value="Platforms">
                                            <label for="platforms">Platforms</label>
                                        </div>
                                        <div class="checkbox-item">
                                            <input type="checkbox" id="professional" name="industries" value="Professional Services">
                                            <label for="professional">Professional Services</label>
                                        </div>
                                        <div class="checkbox-item">
                                            <input type="checkbox" id="realestate" name="industries" value="Real Estate">
                                            <label for="realestate">Real Estate</label>
                                        </div>
                                        <div class="checkbox-item">
                                            <input type="checkbox" id="software" name="industries" value="Software">
                                            <label for="software">Software</label>
                                        </div>
                                        <div class="checkbox-item">
                                            <input type="checkbox" id="travel" name="industries" value="Travel and Tourism">
                                            <label for="travel">Travel and Tourism</label>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="field">
                                    <label>Investment Stages</label>
                                    <div class="checkbox-group">
                                        <div class="checkbox-item">
                                            <input type="checkbox" id="preseed" name="stages" value="Pre-Seed">
                                            <label for="preseed">Pre-Seed</label>
                                        </div>
                                        <div class="checkbox-item">
                                            <input type="checkbox" id="seed" name="stages" value="Seed">
                                            <label for="seed">Seed</label>
                                        </div>
                                        <div class="checkbox-item">
                                            <input type="checkbox" id="seriesa" name="stages" value="Series A">
                                            <label for="seriesa">Series A</label>
                                        </div>
                                        <div class="checkbox-item">
                                            <input type="checkbox" id="seriesb" name="stages" value="Series B">
                                            <label for="seriesb">Series B</label>
                                        </div>
                                        <div class="checkbox-item">
                                            <input type="checkbox" id="seriesc" name="stages" value="Series C">
                                            <label for="seriesc">Series C</label>
                                        </div>
                                        <div class="checkbox-item">
                                            <input type="checkbox" id="growth" name="stages" value="Growth">
                                            <label for="growth">Growth</label>
                                        </div>
                                        <div class="checkbox-item">
                                            <input type="checkbox" id="latestage" name="stages" value="Late Stage">
                                            <label for="latestage">Late Stage</label>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="field">
                                    <label for="overview">Overview/Description</label>
                                    <textarea id="overview" name="overview" placeholder="Brief description of the family office's investment focus and background"></textarea>
                                </div>
                            </div>

                            <!-- Section 3: Primary Contact -->
                            <div class="section hidden" id="section3">
                                <div class="section-title">
                                    <span class="section-number">3</span>
                                    Primary Contact
                                </div>
                                
                                <div class="field-group">
                                    <div class="field">
                                        <label for="contact1FirstName">First Name <span class="required">*</span></label>
                                        <input type="text" id="contact1FirstName" name="contact1FirstName" required>
                                    </div>
                                    <div class="field">
                                        <label for="contact1LastName">Last Name <span class="required">*</span></label>
                                        <input type="text" id="contact1LastName" name="contact1LastName" required>
                                    </div>
                                </div>
                                
                                <div class="field-group">
                                    <div class="field">
                                        <label for="contact1Email">Email</label>
                                        <input type="email" id="contact1Email" name="contact1Email">
                                    </div>
                                    <div class="field">
                                        <label for="contact1Title">Title</label>
                                        <input type="text" id="contact1Title" name="contact1Title">
                                    </div>
                                </div>
                                
                                <div class="field">
                                    <label for="contact1LinkedIn">LinkedIn</label>
                                    <input type="text" id="contact1LinkedIn" name="contact1LinkedIn" placeholder="Full LinkedIn URL or just the profile name">
                                </div>
                            </div>

                            <!-- Section 4: Secondary Contact -->
                            <div class="section hidden" id="section4">
                                <div class="section-title">
                                    <span class="section-number">4</span>
                                    Secondary Contact (Optional)
                                </div>
                                
                                <div class="field-group">
                                    <div class="field">
                                        <label for="contact2FirstName">First Name</label>
                                        <input type="text" id="contact2FirstName" name="contact2FirstName">
                                    </div>
                                    <div class="field">
                                        <label for="contact2LastName">Last Name</label>
                                        <input type="text" id="contact2LastName" name="contact2LastName">
                                    </div>
                                </div>
                                
                                <div class="field-group">
                                    <div class="field">
                                        <label for="contact2Email">Email</label>
                                        <input type="email" id="contact2Email" name="contact2Email">
                                    </div>
                                    <div class="field">
                                        <label for="contact2Title">Title</label>
                                        <input type="text" id="contact2Title" name="contact2Title">
                                    </div>
                                </div>
                                
                                <div class="field">
                                    <label for="contact2LinkedIn">LinkedIn</label>
                                    <input type="text" id="contact2LinkedIn" name="contact2LinkedIn">
                                </div>
                            </div>

                            <!-- Section 5: Additional Information -->
                            <div class="section hidden" id="section5">
                                <div class="section-title">
                                    <span class="section-number">5</span>
                                    Additional Information
                                </div>
                                
                                <div class="field">
                                    <label for="fundRestrictions">Fund Restrictions</label>
                                    <textarea id="fundRestrictions" name="fundRestrictions" placeholder="Any specific restrictions or criteria for investments"></textarea>
                                </div>
                                
                                <div class="field">
                                    <label for="fundRestrictionNotes">Fund Restriction Notes</label>
                                    <textarea id="fundRestrictionNotes" name="fundRestrictionNotes"></textarea>
                                </div>
                                
                                <div class="field">
                                    <label for="portfolio">Portfolio Notes</label>
                                    <textarea id="portfolio" name="portfolio" placeholder="Notable portfolio companies or investment examples"></textarea>
                                </div>
                                
                                <div class="field">
                                    <label for="categories">Categories/Tags</label>
                                    <input type="text" id="categories" name="categories" placeholder="Additional tags or categories (comma-separated)">
                                </div>
                            </div>

                            <div class="error-message" id="errorMessage"></div>

                            <div class="button-group">
                                <button type="button" class="btn btn-secondary" id="prevBtn" onclick="previousSection()" style="display: none;">
                                    ← Previous
                                </button>
                                <button type="button" class="btn btn-primary" id="nextBtn" onclick="nextSection()">
                                    Next →
                                </button>
                                <button type="button" class="btn btn-primary" id="submitBtn" style="display: none;" onclick="handleSubmit()">
                                    Submit Entry
                                </button>
                            </div>
                        </form>

                        <!-- Hidden form for actual submission -->
                        <form id="hiddenForm" method="POST" target="hiddenIframe" style="display: none;">
                            <!-- Hidden inputs will be populated by JavaScript -->
                        </form>
                        <iframe name="hiddenIframe" style="display: none;"></iframe>

                        <div class="success-message" id="successMessage" style="display: none;">
                            <h3>✅ Successfully Submitted!</h3>
                            <p>Thank you! Your family office data has been submitted for review and will be processed shortly.</p>
                            <button class="btn btn-primary" onclick="resetForm()" style="margin-top: 20px;">Submit Another Entry</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Notes Page - FULLY FUNCTIONAL -->
            <div id="notes-page" class="page-content">
                <div class="content-header">
                    <div class="content-header-top">
                        <div>
                            <h1 class="page-title">Notes Overview</h1>
                            <p class="page-subtitle">View all notes across all family offices</p>
                        </div>
                        <div class="header-actions">
                            <button class="btn btn-secondary" onclick="refreshNotes()">🔄 Refresh</button>
                            <button class="btn btn-secondary" onclick="showPage('dashboard')">← Back to Dashboard</button>
                        </div>
                    </div>
                </div>

                <div class="content-body">
                    <!-- Notes Filter Section -->
                    <div class="search-section">
                        <h3>🔍 Filter Notes</h3>
                        
                        <div class="search-grid">
                            <div class="form-group">
                                <label>Search Notes</label>
                                <input type="text" id="searchNotes" placeholder="Search in notes..." oninput="filterNotes()">
                            </div>
                            
                            <div class="form-group">
                                <label>Note Type</label>
                                <select id="filterNoteType" onchange="filterNotes()">
                                    <option value="">All Types</option>
                                    <option value="call">📞 Call</option>
                                    <option value="email">📧 Email</option>
                                    <option value="meeting">🤝 Meeting</option>
                                    <option value="other">📋 Other</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label>Deal Name</label>
                                <select id="filterNoteDeal" onchange="filterNotes()">
                                    <option value="">All Deals</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label>Date Range</label>
                                <input type="date" id="filterNoteDateFrom" onchange="filterNotes()">
                            </div>
                        </div>
                    </div>

                    <!-- Notes List -->
                    <div class="results-section">
                        <div class="results-header">
                            <div class="results-count" id="notesCount">Loading notes...</div>
                        </div>
                        
                        <div id="notesOverviewList" style="margin-top: 20px;">
                            <!-- Notes will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Notes Modal -->
    <div class="modal" id="notesModal">
        <div class="modal-content">
            <button class="close-modal" onclick="closeNotesModal()">×</button>
            <div class="modal-header">
                <h3 id="notesModalTitle">Notes for Family Office</h3>
                <p id="notesModalSubtitle">Manage your interactions and follow-ups</p>
            </div>
            
            <div class="modal-body">
                <!-- Add Note Section -->
                <div style="background: #f8f9fa; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                    <h4 style="margin-bottom: 15px; color: #495057;">📝 Add New Note</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                        <div class="form-group">
                            <label>Note Type</label>
                            <select id="noteType">
                                <option value="call">📞 Call</option>
                                <option value="email">📧 Email</option>
                                <option value="meeting">🤝 Meeting</option>
                                <option value="other">📋 Other</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>Deal Name</label>
                            <select id="dealName" onchange="handleDealSelection()">
                                <option value="">Select existing deal or create new...</option>
                                <option value="__create_new__">➕ Create New Deal</option>
                            </select>
                            <input type="text" id="dealNameInput" placeholder="Enter new deal name..." style="display: none; margin-top: 8px;">
                        </div>
                        
                        <div class="form-group">
                            <label>Date</label>
                            <input type="date" id="noteDate">
                        </div>
                        
                        <div class="form-group" style="grid-column: 1 / -1;">
                            <label>Note Content</label>
                            <textarea id="noteContent" placeholder="Enter your note here..." style="min-height: 100px;"></textarea>
                        </div>
                    </div>
                    
                    <button class="btn btn-success" onclick="addNote()">💾 Save Note</button>
                </div>
                
                <!-- Notes List -->
                <div id="notesList">
                    <!-- Notes will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- User Management Modal -->
    <div class="modal" id="userManagementModal">
        <div class="modal-content" style="max-width: 1200px;">
            <button class="close-modal" onclick="closeUserManagement()">×</button>
            <div class="modal-header">
                <h3>👥 User Management</h3>
                <p>Manage system users, roles, and permissions</p>
            </div>
            
            <div class="modal-body">
                <!-- Controls -->
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
                    <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                        <input type="text" id="userSearch" placeholder="Search users..." style="padding: 8px 12px; border: 2px solid #dee2e6; border-radius: 8px; width: 200px;" oninput="filterUsers()">
                        <select id="userFilterRole" style="padding: 8px 12px; border: 2px solid #dee2e6; border-radius: 8px;" onchange="filterUsers()">
                            <option value="">All Roles</option>
                            <option value="admin">Admin</option>
                            <option value="manager">Manager</option>
                            <option value="user">User</option>
                        </select>
                    </div>
                    <button class="btn btn-success" onclick="showAddUser()">➕ Add New User</button>
                </div>
                
                <!-- Users Table -->
                <div id="usersList" style="max-height: 400px; overflow-y: auto;">
                    <!-- Users will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Change Password Modal -->
    <div class="modal" id="changePasswordModal">
        <div class="modal-content" style="max-width: 500px;">
            <button class="close-modal" onclick="closeChangePassword()">×</button>
            <div class="modal-header">
                <h3>🔑 Change Password</h3>
                <p>Update your account password</p>
            </div>
            
            <div class="modal-body">
                <div class="form-group">
                    <label>Current Password*</label>
                    <input type="password" id="currentPassword" placeholder="Enter current password..." required>
                </div>
                
                <div class="form-group">
                    <label>New Password*</label>
                    <input type="password" id="newPassword" placeholder="Enter new password..." required minlength="12" oninput="checkPasswordStrength()">
                    <div style="font-size: 0.8em; margin-top: 10px;">
                        <div style="color: #dc3545;" id="passwordRequirements">
                            <div>❌ At least 12 characters</div>
                            <div>❌ One uppercase letter</div>
                            <div>❌ One lowercase letter</div>
                            <div>❌ One number</div>
                            <div>❌ One special character</div>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Confirm New Password*</label>
                    <input type="password" id="confirmPassword" placeholder="Confirm new password..." required oninput="checkPasswordMatch()">
                    <div id="confirmMatch" style="font-size: 0.85em; margin-top: 5px;"></div>
                </div>
                
                <button class="btn btn-success" onclick="updatePassword()" id="updatePasswordBtn" style="width: 100%; margin-top: 20px;">
                    🔐 Update Password
                </button>
            </div>
        </div>
    </div>

    <!-- Add User Modal -->
    <div class="modal" id="addUserModal">
        <div class="modal-content" style="max-width: 600px;">
            <button class="close-modal" onclick="closeAddUser()">×</button>
            <div class="modal-header">
                <h3>👤 Add New User</h3>
                <p>Create a new user account for the CRM system</p>
            </div>
            
            <div class="modal-body">
                <form id="addUserForm">
                    <div class="form-group">
                        <label>Full Name*</label>
                        <input type="text" id="newUserName" placeholder="Enter full name..." required>
                    </div>
                    
                    <div class="form-group">
                        <label>Email Address*</label>
                        <input type="email" id="newUserEmail" placeholder="Enter email address..." required>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label>Role*</label>
                            <select id="newUserRole" required>
                                <option value="">Select role...</option>
                                <option value="user">User</option>
                                <option value="manager">Manager</option>
                                <option value="admin">Admin</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>Department*</label>
                            <select id="newUserDepartment" required>
                                <option value="">Select department...</option>
                                <option value="Investment">Investment</option>
                                <option value="Research">Research</option>
                                <option value="Operations">Operations</option>
                                <option value="Administration">Administration</option>
                                <option value="Technology">Technology</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Temporary Password*</label>
                        <input type="password" id="newUserPassword" placeholder="Enter temporary password..." required minlength="12" oninput="checkNewUserPasswordStrength()">
                        <div style="font-size: 0.8em; margin-top: 10px;">
                            <div style="color: #dc3545;" id="newUserPasswordRequirements">
                                <div>❌ At least 12 characters</div>
                                <div>❌ One uppercase letter</div>
                                <div>❌ One lowercase letter</div>
                                <div>❌ One number</div>
                                <div>❌ One special character</div>
                            </div>
                        </div>
                        <p style="font-size: 0.8em; color: #666; margin-top: 8px;">
                            User will be required to change this password on first login
                        </p>
                    </div>
                    
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 8px; font-weight: normal;">
                            <input type="checkbox" id="newUserActive" checked style="width: auto;">
                            Account Active (user can login immediately)
                        </label>
                    </div>
                    
                    <div id="addUserError" style="color: #dc3545; margin: 15px 0; display: none;"></div>
                    
                    <div class="button-group" style="margin-top: 20px;">
                        <button type="button" class="btn btn-secondary" onclick="closeAddUser()">Cancel</button>
                        <button type="button" class="btn btn-success" onclick="createUser()" id="createUserBtn">
                            ➕ Create User
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const CONFIG = {
            apiUrl: 'https://script.google.com/macros/s/AKfycbxqrI_dlu82qxZ40QApEm397JXsj2oVpZwzFtJODyXeEdFSybkVU-CkYHa_8oE-RyFI/exec',
            addEntryUrl: 'https://script.google.com/macros/s/AKfycbz52V4lDsof0PPiiwbJOPkhc99QimMDQo8bKmvLreb6Ydl11wBCpzfiOG_7zEhX-lYB/exec',
            maxLoginAttempts: 5,
            sessionTimeout: 30 * 60 * 1000, // 30 minutes
            passwordMinLength: 12
        };

        // Global variables
        let allInvestors = [];
        let filteredInvestors = [];
        let notesData = [];
        let allUsers = [];
        let filteredUsers = [];
        let currentUser = null;
        let currentContactId = null;
        let editingUserEmail = null;
        let isAuthenticated = false;
        let loginAttempts = 0;
        let sessionTimer = null;
        let currentPage = 1;
        let pageSize = parseInt(localStorage.getItem('crmPageSize') || '30');
        let sortOrder = 'default';
        let sortDirection = 'asc';

        // Add Entry Form Variables
        let currentSection = 1;
        const totalSections = 5;

        // Theme Management System
        const ThemeManager = {
            defaultTheme: {
                'accent-blue': '#3b82f6',
                'accent-blue-hover': '#2563eb',
                'accent-purple': '#8b5cf6',
                'sidebar-bg': '#1a1d29',
                'primary-bg': '#fafbfc',
                'secondary-bg': '#ffffff',
                'border-color': '#e1e5e9'
            },

            presetThemes: {
                default: {
                    'accent-blue': '#3b82f6',
                    'accent-purple': '#8b5cf6',
                    'sidebar-bg': '#1a1d29'
                },
                purple: {
                    'accent-blue': '#8b5cf6',
                    'accent-purple': '#a855f7',
                    'sidebar-bg': '#2d1b69'
                },
                green: {
                    'accent-blue': '#10b981',
                    'accent-purple': '#059669',
                    'sidebar-bg': '#064e3b'
                },
                orange: {
                    'accent-blue': '#f59e0b',
                    'accent-purple': '#d97706',
                    'sidebar-bg': '#92400e'
                },
                dark: {
                    'primary-bg': '#1f2937',
                    'secondary-bg': '#374151',
                    'border-color': '#4b5563',
                    'text-primary': '#f9fafb',
                    'text-secondary': '#d1d5db',
                    'sidebar-bg': '#111827',
                    'surface-hover': '#4b5563'
                },
                minimal: {
                    'primary-bg': '#ffffff',
                    'secondary-bg': '#ffffff',
                    'border-color': '#e9ecef',
                    'sidebar-bg': '#f8f9fa',
                    'sidebar-hover': '#e9ecef',
                    'accent-blue': '#007bff',
                    'accent-purple': '#6f42c1',
                    'text-primary': '#212529',
                    'text-secondary': '#6c757d',
                    'surface-hover': '#f8f9fa'
                }
            },

            loadTheme() {
                const savedTheme = localStorage.getItem('crm-theme');
                if (savedTheme) {
                    try {
                        const theme = JSON.parse(savedTheme);
                        this.applyTheme(theme);
                    } catch (e) {
                        console.error('Failed to load saved theme:', e);
                    }
                }
            },

            applyTheme(theme) {
                const root = document.documentElement;
                // First, reset to defaults to ensure clean slate
                Object.entries(this.defaultTheme).forEach(([key, value]) => {
                    root.style.setProperty(`--${key}`, value);
                });
                // Then apply the new theme
                Object.entries(theme).forEach(([key, value]) => {
                    root.style.setProperty(`--${key}`, value);
                });
            },

            saveTheme() {
                const currentTheme = this.getCurrentTheme();
                localStorage.setItem('crm-theme', JSON.stringify(currentTheme));
                showMessage('Theme saved successfully!', 'success');
            },

            getCurrentTheme() {
                const theme = {};
                const colorInputs = {
                    'accent-blue': document.getElementById('accentPrimary').value,
                    'accent-purple': document.getElementById('accentSecondary').value,
                    'sidebar-bg': document.getElementById('sidebarBg').value,
                    'primary-bg': document.getElementById('primaryBg').value
                };
                
                Object.assign(theme, colorInputs);
                return theme;
            },

            resetTheme() {
                this.applyTheme(this.defaultTheme);
                localStorage.removeItem('crm-theme');
                showMessage('Theme reset to defaults', 'success');
            }
        };

        // ====================
        // PAGE NAVIGATION
        // ====================

        function showPage(pageId) {
            // Hide all pages
            document.querySelectorAll('.page-content').forEach(page => {
                page.classList.remove('active');
            });
            
            // Show selected page
            const targetPage = document.getElementById(`${pageId}-page`);
            if (targetPage) {
                targetPage.classList.add('active');
            }
            
            // Update navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Update active nav item
            if (event && event.target) {
                const navItem = event.target.closest('.nav-item');
                if (navItem) {
                    navItem.classList.add('active');
                }
            }
            
            // Close mobile menu if open
            if (window.innerWidth <= 1024) {
                const sidebar = document.getElementById('sidebar');
                const overlay = document.querySelector('.sidebar-overlay');
                if (sidebar && sidebar.classList.contains('mobile-open')) {
                    sidebar.classList.remove('mobile-open');
                    overlay.classList.remove('show');
                }
            }
            
            // Initialize specific page functionality
            if (pageId === 'notes') {
                displayAllNotes();
            } else if (pageId === 'add-entry') {
                initializeAddEntryForm();
            }
            
            resetSessionTimer();
        }

        // ====================
        // UTILITY FUNCTIONS
        // ====================

        function getInitials(name) {
            if (!name) return 'U';
            return name.split(' ').map(n => n[0]).join('').toUpperCase();
        }

        function sanitizeInput(input) {
            if (typeof input !== 'string') return input || '';
            
            return input
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#x27;')
                .replace(/\//g, '&#x2F;')
                .trim();
        }

        function generateContactId(investor) {
            const name = (investor.investor || investor.name || '').trim().toLowerCase();
            const domain = (investor.domain || investor.website || '').trim().toLowerCase();
            const country = (investor.maincountry || investor.country || '').trim().toLowerCase();
            const email = (investor.contact1email || '').trim().toLowerCase();
            
            let id = '';
            if (name) id += name.replace(/[^a-z0-9]/g, '_');
            if (domain) id += '_' + domain.replace(/[^a-z0-9]/g, '_');
            if (!id && email) id = email.replace(/[^a-z0-9]/g, '_');
            if (!id && country) id = 'contact_' + country.replace(/[^a-z0-9]/g, '_');
            
            if (!id) {
                const str = JSON.stringify(investor);
                id = 'contact_' + Math.abs(str.split('').reduce((a, b) => {
                    a = ((a << 5) - a) + b.charCodeAt(0);
                    return a & a;
                }, 0)).toString();
            }
            
            return id.substring(0, 50);
        }

        // Add Entry Debug Functions
        function debugLog(message) {
            const timestamp = new Date().toLocaleTimeString();
            console.log('DEBUG:', message);
            const debugDiv = document.getElementById('debugInfo');
            const debugContent = document.getElementById('debugContent');
            if (debugContent) {
                debugContent.innerHTML += '<br>' + timestamp + ': ' + message;
                
                // Auto-scroll to bottom
                if (debugDiv) {
                    debugDiv.scrollTop = debugDiv.scrollHeight;
                }
            }
        }

        function testConnection() {
            debugLog('Testing connection to Google Apps Script...');
            
            // Test with GET request first
            fetch(CONFIG.addEntryUrl)
                .then(response => response.json())
                .then(data => {
                    debugLog('✅ Connection test successful: ' + JSON.stringify(data));
                })
                .catch(error => {
                    debugLog('❌ Connection test failed: ' + error.message);
                });
        }

        function testFormData() {
            debugLog('Testing form data collection...');
            
            // Fill form with test data
            document.getElementById('investor').value = 'Test Family Office';
            document.getElementById('msaUser').value = 'TEST';
            document.getElementById('mainCountry').value = 'United Kingdom';
            document.getElementById('mainCity').value = 'London';
            document.getElementById('contact1FirstName').value = 'John';
            document.getElementById('contact1LastName').value = 'Doe';
            
            // Select some industries
            document.getElementById('software').checked = true;
            document.getElementById('financial').checked = true;
            
            debugLog('✅ Test data populated');
            
            // Test data collection
            const testData = collectFormData();
            debugLog('Collected data: ' + JSON.stringify(testData, null, 2));
        }

        function clearDebugLog() {
            const debugContent = document.getElementById('debugContent');
            if (debugContent) {
                debugContent.innerHTML = 'Debug log cleared';
            }
        }

        function toggleTestSection() {
            const testSection = document.getElementById('testSection');
            if (testSection) {
                testSection.style.display = testSection.style.display === 'none' ? 'block' : 'none';
            }
        }

        // ====================
        // API FUNCTIONS
        // ====================

        function makeJSONPRequest(action, params = {}) {
            return new Promise((resolve, reject) => {
                const callbackName = 'jsonp_callback_' + Date.now();
                
                window[callbackName] = function(data) {
                    cleanup();
                    resolve(data);
                };
                
                function cleanup() {
                    delete window[callbackName];
                    if (document.head.contains(script)) {
                        document.head.removeChild(script);
                    }
                }
                
                const script = document.createElement('script');
                const urlParams = new URLSearchParams({
                    action: action,
                    callback: callbackName,
                    timestamp: Date.now(),
                    ...params
                });
                
                script.src = `${CONFIG.apiUrl}?${urlParams.toString()}`;
                script.onerror = () => {
                    cleanup();
                    reject(new Error(`JSONP request failed for action: ${action}`));
                };
                
                const timeout = setTimeout(() => {
                    cleanup();
                    reject(new Error(`Request timeout for action: ${action}`));
                }, 15000);
                
                const originalCallback = window[callbackName];
                window[callbackName] = function(data) {
                    clearTimeout(timeout);
                    originalCallback(data);
                };
                
                document.head.appendChild(script);
            });
        }

        async function testAPIConnection() {
            console.log('Testing API connection with JSONP...');
            showMessage('🔧 Testing API connection...', 'info');
            
            try {
                const result = await makeJSONPRequest('test');
                
                if (result.status === 'success') {
                    showMessage('✅ API connection successful!', 'success');
                    console.log('API test result:', result);
                    return true;
                } else {
                    throw new Error(result.error || 'API test failed');
                }
                
            } catch (error) {
                console.error('API test failed:', error);
                showMessage(`❌ API connection failed: ${error.message}`, 'error');
                return false;
            }
        }

        // ====================
        // UI HELPER FUNCTIONS
        // ====================

        function showMessage(message, type) {
            const statusDiv = document.getElementById('statusMessage');
            if (statusDiv) {
                statusDiv.innerHTML = `<div class="status-message status-${type}">${message}</div>`;

                setTimeout(() => {
                    statusDiv.innerHTML = '';
                }, 5000);
            }
        }

        function showLoading(show) {
            const loading = document.getElementById('loadingIndicator');
            const grid = document.getElementById('investorGrid');
            
            if (loading && grid) {
                if (show) {
                    loading.style.display = 'block';
                    grid.style.display = 'none';
                } else {
                    loading.style.display = 'none';
                    grid.style.display = 'grid';
                }
            }
        }

        function hideSecurityAlert() {
            const alert = document.getElementById('securityAlert');
            if (alert) {
                alert.style.display = 'none';
            }
        }

        function toggleMobileMenu() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.querySelector('.sidebar-overlay');
            
            if (sidebar && overlay) {
                sidebar.classList.toggle('mobile-open');
                overlay.classList.toggle('show');
            }
        }

        function toggleThemePanel() {
            const panel = document.getElementById('themePanel');
            if (panel) {
                panel.classList.toggle('open');
            }
        }

        function applyPresetTheme(preset) {
            const presetConfig = ThemeManager.presetThemes[preset];
            if (presetConfig) {
                ThemeManager.applyTheme(presetConfig);
                
                // Update color inputs
                if (presetConfig['accent-blue']) document.getElementById('accentPrimary').value = presetConfig['accent-blue'];
                if (presetConfig['accent-purple']) document.getElementById('accentSecondary').value = presetConfig['accent-purple'];
                if (presetConfig['sidebar-bg']) document.getElementById('sidebarBg').value = presetConfig['sidebar-bg'];
                if (presetConfig['primary-bg']) document.getElementById('primaryBg').value = presetConfig['primary-bg'];
                
                showMessage(`Applied ${preset} theme`, 'success');
            }
        }

        function updateColors() {
            const updates = {
                'accent-blue': document.getElementById('accentPrimary').value,
                'accent-blue-hover': adjustBrightness(document.getElementById('accentPrimary').value, -20),
                'accent-purple': document.getElementById('accentSecondary').value,
                'sidebar-bg': document.getElementById('sidebarBg').value,
                'sidebar-hover': adjustBrightness(document.getElementById('sidebarBg').value, 20),
                'primary-bg': document.getElementById('primaryBg').value
            };
            ThemeManager.applyTheme(updates);
        }

        function saveTheme() {
            ThemeManager.saveTheme();
        }

        function resetTheme() {
            if (confirm('Are you sure you want to reset all customizations?')) {
                ThemeManager.resetTheme();
                
                // Reset color inputs
                document.getElementById('accentPrimary').value = '#3b82f6';
                document.getElementById('accentSecondary').value = '#8b5cf6';
                document.getElementById('sidebarBg').value = '#1a1d29';
                document.getElementById('primaryBg').value = '#fafbfc';
            }
        }

        function adjustBrightness(hex, percent) {
            const num = parseInt(hex.replace("#", ""), 16);
            const amt = Math.round(2.55 * percent);
            const R = (num >> 16) + amt;
            const G = (num >> 8 & 0x00FF) + amt;
            const B = (num & 0x0000FF) + amt;
            return "#" + (0x1000000 + (R < 255 ? R < 1 ? 0 : R : 255) * 0x10000 +
                (G < 255 ? G < 1 ? 0 : G : 255) * 0x100 +
                (B < 255 ? B < 1 ? 0 : B : 255)).toString(16).slice(1);
        }

        // ====================
        // AUTHENTICATION FUNCTIONS
        // ====================

        async function login() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            const errorDiv = document.getElementById('loginError');
            const loginButton = document.getElementById('loginButton');
            const loginButtonText = document.getElementById('loginButtonText');

            if (!email || !password) {
                errorDiv.textContent = 'Please enter both email and password';
                return;
            }

            if (!email.includes('@')) {
                errorDiv.textContent = 'Please enter a valid email address';
                return;
            }

            if (loginAttempts >= CONFIG.maxLoginAttempts) {
                errorDiv.textContent = 'Too many login attempts. Please wait 15 minutes.';
                return;
            }

            loginButton.disabled = true;
            loginButton.classList.add('btn-loading');
            loginButtonText.textContent = 'Signing in...';
            errorDiv.textContent = '';

            try {
                loginAttempts++;
                console.log('Attempting JSONP login for:', email);

                const result = await makeJSONPRequest('authenticate', {
                    email: email,
                    password: password
                });
                
                console.log('Login result:', result);
                
                if (result.success && result.user && result.user.active) {
                    currentUser = result.user;
                    currentUser.initials = getInitials(currentUser.name);
                    isAuthenticated = true;
                    loginAttempts = 0;
                    
                    showMainApp();
                    startSessionTimer();
                    showMessage('✅ Login successful!', 'success');
                } else {
                    throw new Error(result.error || 'Invalid credentials or inactive account');
                }
                
            } catch (error) {
                console.error('Login error:', error);
                errorDiv.textContent = error.message;
                
                if (loginAttempts < CONFIG.maxLoginAttempts) {
                    errorDiv.textContent += ` (${CONFIG.maxLoginAttempts - loginAttempts} attempts remaining)`;
                }
            } finally {
                loginButton.disabled = false;
                loginButton.classList.remove('btn-loading');
                loginButtonText.textContent = 'Sign In';
            }
        }

        function logout() {
            isAuthenticated = false;
            currentUser = null;
            clearTimeout(sessionTimer);
            
            document.getElementById('loginModal').style.display = 'flex';
            document.getElementById('mainApp').style.display = 'none';
            
            document.getElementById('loginEmail').value = '';
            document.getElementById('loginPassword').value = '';
            document.getElementById('loginError').textContent = '';
        }

        function showMainApp() {
            document.getElementById('loginModal').style.display = 'none';
            document.getElementById('mainApp').style.display = 'flex';
            
            document.getElementById('userName').textContent = currentUser.name;
            document.getElementById('headerUserName').textContent = currentUser.name;
            document.getElementById('userAvatar').textContent = currentUser.initials;
            document.getElementById('userRole').textContent = `${currentUser.role.charAt(0).toUpperCase() + currentUser.role.slice(1)} • ${currentUser.department}`;
            
            loadData();
        }

        // ====================
        // SESSION MANAGEMENT
        // ====================

        function startSessionTimer() {
            clearTimeout(sessionTimer);
            sessionTimer = setTimeout(() => {
                showMessage('⚠️ Session expired for security. Please log in again.', 'warning');
                logout();
            }, CONFIG.sessionTimeout);
        }

        function resetSessionTimer() {
            if (isAuthenticated) {
                startSessionTimer();
                updateSessionInfo();
            }
        }

        function updateSessionInfo() {
            const sessionInfo = document.getElementById('sessionInfo');
            if (sessionInfo && isAuthenticated) {
                const timeLeft = Math.round(CONFIG.sessionTimeout / 60000);
                sessionInfo.textContent = `Session expires in ${timeLeft} min`;
            }
        }

        // ====================
        // DATA LOADING FUNCTIONS
        // ====================

        async function loadData() {
            showLoading(true);
            
            try {
                console.log('Loading data from Google Sheets...');
                resetSessionTimer();
                
                const investorsData = await makeJSONPRequest('getInvestors');
                console.log('Investors data received:', investorsData);
                
                if (investorsData.error) {
                    throw new Error(investorsData.error);
                }

                allInvestors = investorsData.investors || [];
                filteredInvestors = [...allInvestors];

                await loadNotes();
                
                populateFilterDropdowns();
                displayInvestors();
                
                showMessage(`✅ Loaded ${allInvestors.length} family offices from Google Sheets!`, 'success');
                
            } catch (error) {
                console.error('Error loading data:', error);
                showMessage(`❌ Error loading data: ${error.message}`, 'error');
                
                const resultsCount = document.getElementById('resultsCount');
                const investorGrid = document.getElementById('investorGrid');
                
                if (resultsCount) resultsCount.textContent = 'Error loading data';
                if (investorGrid) {
                    investorGrid.innerHTML = `
                        <div style="grid-column: 1/-1; text-align: center; padding: 40px; background: #f8d7da; border-radius: 12px; border: 1px solid #f5c6cb; color: #721c24;">
                            <h3>Unable to load data from Google Sheets</h3>
                            <p style="margin: 10px 0;">${error.message}</p>
                            <div style="margin-top: 20px;">
                                <button class="btn btn-primary" onclick="loadData()">🔄 Try Again</button>
                            </div>
                        </div>
                    `;
                }
            }
            
            showLoading(false);
        }

        async function loadNotes() {
            console.log('Loading notes from Google Sheets...');
            try {
                const notesResponse = await makeJSONPRequest('getNotes');
                console.log('Notes data received:', notesResponse);
                
                if (notesResponse.error) {
                    console.warn('Notes loading failed:', notesResponse.error);
                    notesData = [];
                } else {
                    notesData = notesResponse.notes || [];
                }
                
                console.log(`Loaded ${notesData.length} notes from Google Sheets`);
                
            } catch (error) {
                console.error('Error loading notes:', error);
                notesData = [];
            }
        }

        function refreshData() {
            loadData();
        }

        // ====================
        // SEARCH AND FILTER FUNCTIONS
        // ====================

        function populateFilterDropdowns() {
            const countries = [...new Set(allInvestors.map(inv => inv.maincountry || inv.country).filter(Boolean))].sort();
            populateSelect('searchCountry', countries);

            const industries = [...new Set(allInvestors.flatMap(inv => {
                const industryField = inv.industries || inv.industry || '';
                return industryField.toString().split(/[|,]/).map(i => i.trim()).filter(Boolean);
            }))].sort();
            populateSelect('searchIndustry', industries);

            const stages = [...new Set(allInvestors.flatMap(inv => {
                const stageField = inv.stages || inv.stage || '';
                return stageField.toString().split(',').map(s => s.trim()).filter(Boolean);
            }))].sort();
            populateSelect('searchStage', stages);

            const owners = [...new Set(allInvestors.map(inv => inv.msauser || inv.owner).filter(Boolean))].sort();
            populateSelect('searchOwner', owners);

            const dealNames = [...new Set(notesData.map(note => note.dealname || note.dealName).filter(Boolean))].sort();
            populateSelect('searchDeal', dealNames);
        }

        function populateSelect(selectId, options) {
            const select = document.getElementById(selectId);
            if (!select) return;
            
            const currentValue = select.value;
            const firstOption = select.innerHTML.split('</option>')[0] + '</option>';
            
            select.innerHTML = firstOption + options.map(option => 
                `<option value="${sanitizeInput(option)}">${sanitizeInput(option)}</option>`
            ).join('');
            
            select.value = currentValue;
        }

        function searchInvestors() {
            const name = document.getElementById('searchName').value.toLowerCase();
            const country = document.getElementById('searchCountry').value;
            const industry = document.getElementById('searchIndustry').value;
            const stage = document.getElementById('searchStage').value;
            const owner = document.getElementById('searchOwner').value;
            const dealName = document.getElementById('searchDeal').value;

            filteredInvestors = allInvestors.filter(investor => {
                const matchesName = !name || (investor.investor || investor.name || '').toLowerCase().includes(name);
                const matchesCountry = !country || (investor.maincountry || investor.country) === country;
                const matchesIndustry = !industry || (investor.industries || investor.industry || '').includes(industry);
                const matchesStage = !stage || (investor.stages || investor.stage || '').includes(stage);
                const matchesOwner = !owner || (investor.msauser || investor.owner) === owner;
                
                let matchesDeal = true;
                if (dealName) {
                    const contactNotes = notesData.filter(note => 
                        (note.contactid === generateContactId(investor) || note.contact_id === generateContactId(investor)) && 
                        (note.dealname === dealName || note.dealName === dealName)
                    );
                    matchesDeal = contactNotes.length > 0;
                }

                return matchesName && matchesCountry && matchesIndustry && matchesStage && matchesOwner && matchesDeal;
            });

            currentPage = 1;
            displayInvestors();
            resetSessionTimer();
        }

        function clearSearch() {
            document.getElementById('searchName').value = '';
            document.getElementById('searchCountry').value = '';
            document.getElementById('searchIndustry').value = '';
            document.getElementById('searchStage').value = '';
            document.getElementById('searchOwner').value = '';
            document.getElementById('searchDeal').value = '';

            filteredInvestors = [...allInvestors];
            currentPage = 1;
            displayInvestors();
        }

        // ====================
        // PAGINATION FUNCTIONS
        // ====================

        function goToPage(page) {
            const totalPages = Math.ceil(filteredInvestors.length / pageSize);
            
            if (page === 'last') {
                currentPage = totalPages;
            } else {
                currentPage = Math.max(1, Math.min(page, totalPages));
            }
            
            displayInvestors();
            document.querySelector('.results-section').scrollIntoView({ behavior: 'smooth' });
        }

        function previousPage() {
            if (currentPage > 1) {
                currentPage--;
                displayInvestors();
                document.querySelector('.results-section').scrollIntoView({ behavior: 'smooth' });
            }
        }

        function nextPage() {
            const totalPages = Math.ceil(filteredInvestors.length / pageSize);
            if (currentPage < totalPages) {
                currentPage++;
                displayInvestors();
                document.querySelector('.results-section').scrollIntoView({ behavior: 'smooth' });
            }
        }

        function updatePaginationControls() {
            const totalItems = filteredInvestors.length;
            const totalPages = Math.ceil(totalItems / pageSize);
            const startIndex = (currentPage - 1) * pageSize;
            const endIndex = Math.min(startIndex + pageSize, totalItems);
            
            const paginationInfo = document.getElementById('paginationInfo');
            if (paginationInfo) {
                if (totalItems === 0) {
                    paginationInfo.textContent = 'No results found';
                } else {
                    if (window.innerWidth < 768) {
                        paginationInfo.textContent = `${startIndex + 1}-${endIndex} of ${totalItems}`;
                    } else {
                        paginationInfo.textContent = `Showing ${startIndex + 1}-${endIndex} of ${totalItems} results`;
                    }
                }
            }
            
            const firstBtn = document.querySelector('button[onclick="goToPage(1)"]');
            const prevBtn = document.querySelector('button[onclick="previousPage()"]');
            const nextBtn = document.querySelector('button[onclick="nextPage()"]');
            const lastBtn = document.querySelector('button[onclick="goToPage(\'last\')"]');
            
            if (firstBtn) firstBtn.disabled = currentPage === 1;
            if (prevBtn) prevBtn.disabled = currentPage === 1;
            if (nextBtn) nextBtn.disabled = currentPage === totalPages || totalPages === 0;
            if (lastBtn) lastBtn.disabled = currentPage === totalPages || totalPages === 0;
            
            const pageNumbers = document.getElementById('pageNumbers');
            if (pageNumbers) {
                let pageNumbersHtml = '';
                
                if (totalPages <= 7) {
                    for (let i = 1; i <= totalPages; i++) {
                        pageNumbersHtml += createPageButton(i);
                    }
                } else {
                    if (currentPage <= 4) {
                        for (let i = 1; i <= 5; i++) {
                            pageNumbersHtml += createPageButton(i);
                        }
                        pageNumbersHtml += '<span style="padding: 0 10px;">...</span>';
                        pageNumbersHtml += createPageButton(totalPages);
                    } else if (currentPage >= totalPages - 3) {
                        pageNumbersHtml += createPageButton(1);
                        pageNumbersHtml += '<span style="padding: 0 10px;">...</span>';
                        for (let i = totalPages - 4; i <= totalPages; i++) {
                            pageNumbersHtml += createPageButton(i);
                        }
                    } else {
                        pageNumbersHtml += createPageButton(1);
                        pageNumbersHtml += '<span style="padding: 0 10px;">...</span>';
                        for (let i = currentPage - 1; i <= currentPage + 1; i++) {
                            pageNumbersHtml += createPageButton(i);
                        }
                        pageNumbersHtml += '<span style="padding: 0 10px;">...</span>';
                        pageNumbersHtml += createPageButton(totalPages);
                    }
                }
                
                pageNumbers.innerHTML = pageNumbersHtml;
            }
            
            const bottomPagination = document.getElementById('bottomPagination');
            const topPagination = document.getElementById('topPagination');
            if (bottomPagination && topPagination) {
                bottomPagination.innerHTML = topPagination.innerHTML;
            }
        }

        function createPageButton(pageNum) {
            const isActive = pageNum === currentPage;
            return `<button onclick="goToPage(${pageNum})" ${isActive ? 'disabled' : ''} style="
                padding: 8px 12px;
                border: 1px solid ${isActive ? '#282828' : '#dee2e6'};
                background: ${isActive ? '#282828' : 'white'};
                color: ${isActive ? 'white' : '#333'};
                border-radius: 6px;
                cursor: ${isActive ? 'default' : 'pointer'};
                margin: 0 2px;
                font-size: 0.9em;
            ">${pageNum}</button>`;
        }

        // ====================
        // DISPLAY FUNCTIONS
        // ====================

        function displayInvestors() {
            const grid = document.getElementById('investorGrid');
            const count = document.getElementById('resultsCount');

            if (!grid || !count) return;

            const totalItems = filteredInvestors.length;
            const startIndex = (currentPage - 1) * pageSize;
            const endIndex = Math.min(startIndex + pageSize, totalItems);
            const paginatedInvestors = filteredInvestors.slice(startIndex, endIndex);

            count.textContent = `Found ${totalItems} family office${totalItems !== 1 ? 's' : ''}`;

            if (totalItems === 0) {
                grid.innerHTML = `
                    <div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #666;">
                        <h3>No family offices found</h3>
                        <p>Try adjusting your search criteria</p>
                        <button class="btn btn-secondary" onclick="clearSearch()" style="margin-top: 15px;">Clear Search</button>
                    </div>
                `;
                updatePaginationControls();
                return;
            }

            grid.innerHTML = paginatedInvestors.map((investor, index) => {
                const contactId = generateContactId(investor);
                const contactNotes = notesData.filter(note => note.contactid === contactId || note.contact_id === contactId);
                const notesCount = contactNotes.length;

                const name = sanitizeInput(investor.investor || investor.name || `Unnamed Office ${startIndex + index + 1}`);
                const website = sanitizeInput(investor.domain || investor.website || '');
                const country = sanitizeInput(investor.maincountry || investor.country || '');
                const city = sanitizeInput(investor.maincity || investor.city || '');
                const overview = sanitizeInput(investor.overview || investor.description || '');
                const fundrestrictions = sanitizeInput(investor.fundrestrictions || investor.restrictions || '');
                const industries = sanitizeInput(investor.industries || investor.industry || '');
                const stages = sanitizeInput(investor.stages || investor.stage || '');
                const owner = sanitizeInput(investor.msauser || investor.owner || '');
                
                const contact1name = sanitizeInput((investor.contact1firstname || '') + ' ' + (investor.contact1lastname || '')).trim();
                const contact1title = sanitizeInput(investor.contact1title || '');
                const contact1email = sanitizeInput(investor.contact1email || '');
                const contact1linkedin = sanitizeInput(investor.contact1linkedin || '');
                
                const contact2name = sanitizeInput((investor.contact2firstname || '') + ' ' + (investor.contact2lastname || '')).trim();
                const contact2title = sanitizeInput(investor.contact2title || '');
                const contact2email = sanitizeInput(investor.contact2email || '');
                const contact2linkedin = sanitizeInput(investor.contact2linkedin || '');

                const industriesList = industries.split(/[|,]/).map(i => i.trim()).filter(i => i);
                const stagesList = stages.split(',').map(s => s.trim()).filter(s => s);

                return `
                    <div class="investor-card">
                        <button class="notes-button" onclick="openNotesModal('${contactId}', '${name.replace(/'/g, "\\'")}')">
                            📝 Notes
                            ${notesCount > 0 ? `<span class="notes-count">${notesCount}</span>` : ''}
                        </button>
                        
                        <div class="investor-name">${name}</div>
                        
                        ${website ? `
                            <div class="investor-detail">
                                <strong>🌐 Website:</strong>
                                <span><a href="${website.startsWith('http') ? website : 'https://' + website}" target="_blank" rel="noopener noreferrer">${website}</a></span>
                            </div>
                        ` : ''}
                        
                        <div class="investor-detail">
                            <strong>📍 Location:</strong>
                            <span>${[city, country].filter(Boolean).join(', ') || 'Not specified'}</span>
                        </div>
                        
                        ${owner ? `
                            <div class="investor-detail">
                                <strong>👤 Owner:</strong>
                                <span>${owner}</span>
                            </div>
                        ` : ''}
                        
                        ${overview ? `
                            <div class="investor-detail">
                                <strong>📝 Overview:</strong>
                                <span>${overview}</span>
                            </div>
                        ` : ''}
                        
                        ${fundrestrictions ? `
                            <div class="investor-detail">
                                <strong>⚠️ Restrictions:</strong>
                                <span>${fundrestrictions}</span>
                            </div>
                        ` : ''}
                        
                        ${(industriesList.length > 0 || stagesList.length > 0) ? `
                            <div class="tags">
                                ${industriesList.slice(0, 3).map(industry => `<div class="tag">${industry}</div>`).join('')}
                                ${stagesList.slice(0, 2).map(stage => `<div class="tag">${stage}</div>`).join('')}
                            </div>
                        ` : ''}
                        
                        ${(contact1name || contact2name) ? `
                            <div class="contacts-section">
                                <strong style="color: #495057; font-size: 0.9em;">👥 Contacts:</strong>
                                <div class="contacts-grid">
                                    ${contact1name ? `
                                        <div class="contact">
                                            <div class="contact-name">${contact1name}</div>
                                            ${contact1title ? `<div class="contact-detail">${contact1title}</div>` : ''}
                                            ${contact1email ? `<div class="contact-detail">📧 ${contact1email}</div>` : ''}
                                            ${contact1linkedin ? `<div class="contact-detail"><a href="${contact1linkedin}" target="_blank" rel="noopener noreferrer">🔗 LinkedIn</a></div>` : ''}
                                        </div>
                                    ` : ''}
                                    ${contact2name ? `
                                        <div class="contact">
                                            <div class="contact-name">${contact2name}</div>
                                            ${contact2title ? `<div class="contact-detail">${contact2title}</div>` : ''}
                                            ${contact2email ? `<div class="contact-detail">📧 ${contact2email}</div>` : ''}
                                            ${contact2linkedin ? `<div class="contact-detail"><a href="${contact2linkedin}" target="_blank" rel="noopener noreferrer">🔗 LinkedIn</a></div>` : ''}
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');

            updatePaginationControls();
        }

        // ====================
        // ADD ENTRY FORM FUNCTIONS - FULLY RESTORED
        // ====================

        function initializeAddEntryForm() {
            debugLog('DOM Content Loaded');
            updateProgressBar();
            updateButtons();
            debugLog('Form initialization complete');
        }

        function updateProgressBar() {
            const progress = (currentSection / totalSections) * 100;
            const progressFill = document.getElementById('progressFill');
            if (progressFill) {
                progressFill.style.width = progress + '%';
            }
        }

        function updateButtons() {
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const submitBtn = document.getElementById('submitBtn');

            if (prevBtn) prevBtn.style.display = currentSection > 1 ? 'block' : 'none';
            
            if (currentSection === totalSections) {
                if (nextBtn) nextBtn.style.display = 'none';
                if (submitBtn) {
                    submitBtn.style.display = 'block';
                    debugLog('Submit button should now be visible');
                }
            } else {
                if (nextBtn) nextBtn.style.display = 'block';
                if (submitBtn) submitBtn.style.display = 'none';
            }
        }

        function showSection(sectionNumber) {
            debugLog(`Showing section ${sectionNumber}`);
            
            // Hide all sections
            for (let i = 1; i <= totalSections; i++) {
                const section = document.getElementById(`section${i}`);
                if (section) {
                    section.classList.add('hidden');
                }
            }
            
            // Show current section
            const currentSectionEl = document.getElementById(`section${sectionNumber}`);
            if (currentSectionEl) {
                currentSectionEl.classList.remove('hidden');
            }
            
            // Scroll to top
            window.scrollTo(0, 0);
        }

        function nextSection() {
            debugLog('Next section clicked');
            if (validateCurrentSection()) {
                currentSection++;
                showSection(currentSection);
                updateProgressBar();
                updateButtons();
            }
        }

        function previousSection() {
            debugLog('Previous section clicked');
            currentSection--;
            showSection(currentSection);
            updateProgressBar();
            updateButtons();
        }

        function validateCurrentSection() {
            debugLog(`Validating section ${currentSection}`);
            
            const currentSectionElement = document.getElementById(`section${currentSection}`);
            if (!currentSectionElement) return true;
            
            const requiredFields = currentSectionElement.querySelectorAll('[required]');
            let isValid = true;
            let errorMessage = '';

            // Clear previous error styles
            requiredFields.forEach(field => {
                field.style.borderColor = '#ddd';
            });

            // Validate required fields
            requiredFields.forEach(field => {
                if (!field.value.trim()) {
                    field.style.borderColor = '#e74c3c';
                    isValid = false;
                    errorMessage = 'Please fill in all required fields marked with *';
                }
            });

            // Special validation for industries (at least one checkbox must be selected)
            if (currentSection === 2) {
                const industriesChecked = document.querySelectorAll('input[name="industries"]:checked');
                if (industriesChecked.length === 0) {
                    isValid = false;
                    errorMessage = 'Please select at least one industry';
                }
            }

            // Show error message if validation fails
            const errorDiv = document.getElementById('errorMessage');
            if (errorDiv) {
                if (!isValid) {
                    errorDiv.textContent = errorMessage;
                    errorDiv.style.display = 'block';
                    debugLog('Validation failed: ' + errorMessage);
                } else {
                    errorDiv.style.display = 'none';
                    debugLog('Validation passed');
                }
            }

            return isValid;
        }

        function collectFormData() {
            debugLog('Collecting form data...');
            
            const formData = new FormData(document.getElementById('familyOfficeForm'));
            
            // Convert checkboxes to comma-separated strings
            const industries = Array.from(document.querySelectorAll('input[name="industries"]:checked'))
                .map(cb => cb.value).join(', ');
            const stages = Array.from(document.querySelectorAll('input[name="stages"]:checked'))
                .map(cb => cb.value).join(', ');

            debugLog('Industries: ' + industries);
            debugLog('Stages: ' + stages);

            // Create submission object
            const submission = {};
            
            // Get all form fields
            for (let [key, value] of formData.entries()) {
                submission[key] = value;
            }
            
            // Override checkboxes with comma-separated values
            submission.industries = industries;
            submission.stages = stages;
            
            // Add metadata
            submission.approved = 'Pending';
            submission.created = new Date().toISOString();
            
            return submission;
        }

        function handleSubmit() {
            debugLog('🚀 SUBMIT BUTTON CLICKED!');
            
            // Validate one more time
            if (!validateCurrentSection()) {
                debugLog('Final validation failed, stopping submission');
                return;
            }

            debugLog('Final validation passed, starting submission...');
            submitForm();
        }

        function submitForm() {
            debugLog('submitForm() function started');
            
            const submitBtn = document.getElementById('submitBtn');
            const originalText = submitBtn.textContent;
            
            try {
                submitBtn.disabled = true;
                submitBtn.textContent = 'Submitting...';
                debugLog('Submit button disabled and text changed');

                // Collect form data
                const submission = collectFormData();
                debugLog('Submission data prepared');
                debugLog('Key fields check: ' + submission.investor + ', ' + submission.msaUser + ', ' + submission.mainCountry + ', ' + submission.contact1FirstName);

                // Create form for submission
                const hiddenForm = document.getElementById('hiddenForm');
                hiddenForm.innerHTML = ''; // Clear previous inputs
                hiddenForm.action = CONFIG.addEntryUrl;
                
                // Add all data as hidden inputs
                Object.keys(submission).forEach(key => {
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = key;
                    input.value = submission[key] || '';
                    hiddenForm.appendChild(input);
                });
                
                debugLog('Hidden form populated with ' + Object.keys(submission).length + ' fields');
                
                // Set up iframe handlers
                const iframe = document.getElementsByName('hiddenIframe')[0];
                
                let submitted = false;
                
                // Success handler
                iframe.onload = function() {
                    if (!submitted) return; // Ignore initial load
                    
                    debugLog('✅ Form submitted via iframe - assuming success');
                    
                    setTimeout(() => {
                        document.getElementById('familyOfficeForm').style.display = 'none';
                        document.getElementById('successMessage').style.display = 'block';
                        const debugInfo = document.getElementById('debugInfo');
                        const testSection = document.getElementById('testSection');
                        if (debugInfo) debugInfo.style.display = 'none';
                        if (testSection) testSection.style.display = 'none';
                    }, 1000);
                };
                
                // Error handler
                iframe.onerror = function() {
                    debugLog('❌ Error during iframe submission');
                    showError('Submission failed. Please try again.');
                    
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalText;
                };
                
                // Submit the form
                debugLog('Submitting form to: ' + CONFIG.addEntryUrl);
                submitted = true;
                hiddenForm.submit();
                
                // Fallback timeout
                setTimeout(() => {
                    if (submitBtn.disabled) {
                        debugLog('⚠️ Fallback timeout - assuming success after 5 seconds');
                        document.getElementById('familyOfficeForm').style.display = 'none';
                        document.getElementById('successMessage').style.display = 'block';
                        const debugInfo = document.getElementById('debugInfo');
                        const testSection = document.getElementById('testSection');
                        if (debugInfo) debugInfo.style.display = 'none';
                        if (testSection) testSection.style.display = 'none';
                    }
                }, 5000);

            } catch (error) {
                debugLog('❌ EXCEPTION: ' + error.message);
                console.error('Submit exception:', error);
                
                showError('Error preparing submission: ' + error.message);
                
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            }
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            if (errorDiv) {
                errorDiv.textContent = message;
                errorDiv.style.display = 'block';
            }
        }

        function resetForm() {
            debugLog('Reset form called');
            
            // Reset form
            const form = document.getElementById('familyOfficeForm');
            if (form) form.reset();
            
            // Reset to first section
            currentSection = 1;
            showSection(1);
            updateProgressBar();
            updateButtons();
            
            // IMPORTANT: Re-enable and reset submit button
            const submitBtn = document.getElementById('submitBtn');
            if (submitBtn) {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Submit Entry';
            }
            
            // Also reset next button in case it was disabled
            const nextBtn = document.getElementById('nextBtn');
            if (nextBtn) {
                nextBtn.disabled = false;
                nextBtn.textContent = 'Next →';
            }
            
            // Hide success message and show form
            const successMsg = document.getElementById('successMessage');
            const formEl = document.getElementById('familyOfficeForm');
            const debugInfo = document.getElementById('debugInfo');
            const testSection = document.getElementById('testSection');
            
            if (successMsg) successMsg.style.display = 'none';
            if (formEl) formEl.style.display = 'block';
            if (debugInfo) debugInfo.style.display = 'block';
            if (testSection) testSection.style.display = 'block';
            
            // Hide error message
            const errorMsg = document.getElementById('errorMessage');
            if (errorMsg) errorMsg.style.display = 'none';
            
            // Clear any field error styling
            const allInputs = document.querySelectorAll('input, select, textarea');
            allInputs.forEach(field => {
                field.style.borderColor = '#ddd';
            });
            
            // Clear debug info
            const debugContent = document.getElementById('debugContent');
            if (debugContent) {
                debugContent.innerHTML = 'Form reset - ready for new entry';
            }
            
            debugLog('✅ Form reset complete - all buttons re-enabled');
        }

        // ====================
        // NOTES MANAGEMENT - FULLY FUNCTIONAL
        // ====================

        function openNotesModal(contactId, contactName) {
            currentContactId = contactId;
            
            document.getElementById('notesModalTitle').textContent = `Notes for ${contactName}`;
            document.getElementById('notesModalSubtitle').textContent = `Manage your interactions and follow-ups with ${contactName}`;
            
            document.getElementById('noteDate').value = new Date().toISOString().split('T')[0];
            
            document.getElementById('noteType').value = 'call';
            document.getElementById('dealName').value = '';
            document.getElementById('dealNameInput').value = '';
            document.getElementById('dealNameInput').style.display = 'none';
            document.getElementById('noteContent').value = '';
            
            populateDealsDropdown();
            displayContactNotes(contactId);
            
            document.getElementById('notesModal').classList.add('show');
            resetSessionTimer();
        }

        function closeNotesModal() {
            document.getElementById('notesModal').classList.remove('show');
            currentContactId = null;
        }

        function handleDealSelection() {
            const dealSelect = document.getElementById('dealName');
            const dealInput = document.getElementById('dealNameInput');
            
            if (dealSelect.value === '__create_new__') {
                dealInput.style.display = 'block';
                dealInput.focus();
            } else {
                dealInput.style.display = 'none';
                dealInput.value = '';
            }
        }

        function populateDealsDropdown() {
            const dealSelect = document.getElementById('dealName');
            const existingDeals = [...new Set(notesData.map(note => note.dealname || note.dealName).filter(Boolean))].sort();
            
            dealSelect.innerHTML = `
                <option value="">Select existing deal or create new...</option>
                <option value="__create_new__">➕ Create New Deal</option>
                ${existingDeals.map(deal => `<option value="${sanitizeInput(deal)}">${sanitizeInput(deal)}</option>`).join('')}
            `;
        }

        function displayContactNotes(contactId) {
            const contactNotes = notesData.filter(note => 
                note.contactid === contactId || note.contact_id === contactId
            );
            const notesList = document.getElementById('notesList');

            if (contactNotes.length === 0) {
                notesList.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <h4>📝 No notes yet</h4>
                        <p>Start by adding your first note above</p>
                    </div>
                `;
                return;
            }

            contactNotes.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            notesList.innerHTML = contactNotes.map(note => {
                const noteTypeIcons = {
                    call: '📞',
                    email: '📧',
                    meeting: '🤝',
                    other: '📋'
                };

                const formattedDate = new Date(note.date).toLocaleDateString();
                const formattedTime = new Date(note.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

                return `
                    <div style="background: white; border: 1px solid #e9ecef; border-radius: 12px; padding: 15px; margin-bottom: 15px; transition: all 0.3s ease;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <div style="display: flex; gap: 15px; align-items: center; font-size: 0.85em; color: #666; flex-wrap: wrap;">
                                <span style="background: #282828; color: white; padding: 3px 8px; border-radius: 12px; font-size: 0.75em; font-weight: 600;">
                                    ${noteTypeIcons[note.notetype || note.type] || '📋'} ${(note.notetype || note.type || 'Note').charAt(0).toUpperCase() + (note.notetype || note.type || 'note').slice(1)}
                                </span>
                                ${(note.dealname || note.dealName) ? `<span style="background: #667eea; color: white; padding: 3px 8px; border-radius: 12px; font-size: 0.75em; font-weight: 600;">💼 ${sanitizeInput(note.dealname || note.dealName)}</span>` : ''}
                                <span>📅 ${formattedDate}</span>
                                <span>🕒 ${formattedTime}</span>
                                <span>👤 ${sanitizeInput(note.user || 'Unknown')}</span>
                            </div>
                        </div>
                        <div style="color: #495057; line-height: 1.5;">${sanitizeInput(note.notecontent || note.content || '')}</div>
                    </div>
                `;
            }).join('');
        }

        async function addNote() {
            const noteType = document.getElementById('noteType').value;
            const dealSelect = document.getElementById('dealName');
            const dealInput = document.getElementById('dealNameInput');
            const noteDate = document.getElementById('noteDate').value;
            const noteContent = document.getElementById('noteContent').value.trim();

            let dealName = '';
            if (dealSelect.value === '__create_new__') {
                dealName = dealInput.value.trim();
                if (!dealName) {
                    showMessage('Please enter a new deal name', 'error');
                    return;
                }
            } else {
                dealName = dealSelect.value;
            }

            if (!noteContent) {
                showMessage('Please enter note content', 'error');
                return;
            }

            if (!noteDate) {
                showMessage('Please select a date', 'error');
                return;
            }

            const newNote = {
                id: Date.now(),
                contactId: currentContactId,
                user: currentUser.name,
                type: noteType,
                dealName: dealName,
                content: noteContent,
                date: noteDate,
                timestamp: new Date().toISOString()
            };

            console.log('Adding new note via JSONP:', newNote);

            try {
                const result = await makeJSONPRequest('addNote', {
                    id: newNote.id,
                    contactId: newNote.contactId,
                    user: newNote.user,
                    type: newNote.type,
                    dealName: newNote.dealName,
                    content: newNote.content,
                    date: newNote.date,
                    timestamp: newNote.timestamp
                });

                console.log('Add note result:', result);
                
                if (result.error) {
                    throw new Error(result.error);
                }

                await loadNotes();

                document.getElementById('noteContent').value = '';
                document.getElementById('dealName').value = '';
                document.getElementById('dealNameInput').value = '';
                document.getElementById('dealNameInput').style.display = 'none';

                populateDealsDropdown();
                displayContactNotes(currentContactId);
                populateFilterDropdowns();
                displayInvestors();

                showMessage('✅ Note saved to Google Sheets successfully!', 'success');

            } catch (error) {
                console.error('Error adding note:', error);
                showMessage(`❌ Failed to save note: ${error.message}`, 'error');
            }
        }

        function displayAllNotes() {
            const notesList = document.getElementById('notesOverviewList');
            const notesCount = document.getElementById('notesCount');
            
            if (!notesList || !notesCount) return;
            
            // Populate deal filter
            const dealFilter = document.getElementById('filterNoteDeal');
            if (dealFilter) {
                const deals = [...new Set(notesData.map(note => note.dealname || note.dealName).filter(Boolean))].sort();
                dealFilter.innerHTML = '<option value="">All Deals</option>' + 
                    deals.map(deal => `<option value="${sanitizeInput(deal)}">${sanitizeInput(deal)}</option>`).join('');
            }
            
            if (notesData.length === 0) {
                notesCount.textContent = 'No notes found';
                notesList.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <h3>📝 No notes yet</h3>
                        <p>Start by adding notes to family offices from the dashboard</p>
                    </div>
                `;
                return;
            }
            
            notesCount.textContent = `Found ${notesData.length} note${notesData.length !== 1 ? 's' : ''}`;
            
            // Sort notes by date (most recent first)
            const sortedNotes = [...notesData].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            notesList.innerHTML = sortedNotes.map(note => {
                // Find the associated investor
                const investor = allInvestors.find(inv => 
                    generateContactId(inv) === note.contactid || generateContactId(inv) === note.contact_id
                );
                const investorName = investor ? (investor.investor || investor.name || 'Unknown') : 'Unknown Family Office';
                
                const noteTypeIcons = {
                    call: '📞',
                    email: '📧',
                    meeting: '🤝',
                    other: '📋'
                };

                const formattedDate = new Date(note.date).toLocaleDateString();
                const formattedTime = new Date(note.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

                return `
                    <div class="note-card">
                        <div class="note-header">
                            <div style="font-weight: 600; font-size: 1.1rem; color: var(--text-primary);">
                                🏢 ${sanitizeInput(investorName)}
                            </div>
                        </div>
                        <div class="note-meta">
                            <span class="note-type-badge">
                                ${noteTypeIcons[note.notetype || note.type] || '📋'} ${(note.notetype || note.type || 'Note').charAt(0).toUpperCase() + (note.notetype || note.type || 'note').slice(1)}
                            </span>
                            ${(note.dealname || note.dealName) ? `<span class="note-deal-badge">💼 ${sanitizeInput(note.dealname || note.dealName)}</span>` : ''}
                            <span>📅 ${formattedDate}</span>
                            <span>🕒 ${formattedTime}</span>
                            <span>👤 ${sanitizeInput(note.user || 'Unknown')}</span>
                        </div>
                        <div class="note-content">${sanitizeInput(note.notecontent || note.content || '')}</div>
                    </div>
                `;
            }).join('');
        }

        function filterNotes() {
            const searchTerm = document.getElementById('searchNotes').value.toLowerCase();
            const typeFilter = document.getElementById('filterNoteType').value;
            const dealFilter = document.getElementById('filterNoteDeal').value;
            const dateFrom = document.getElementById('filterNoteDateFrom').value;
            
            const filteredNotes = notesData.filter(note => {
                // Search filter
                const content = (note.notecontent || note.content || '').toLowerCase();
                const matchesSearch = !searchTerm || content.includes(searchTerm);
                
                // Type filter
                const matchesType = !typeFilter || (note.notetype || note.type) === typeFilter;
                
                // Deal filter
                const matchesDeal = !dealFilter || (note.dealname || note.dealName) === dealFilter;
                
                // Date filter
                let matchesDate = true;
                if (dateFrom) {
                    const noteDate = new Date(note.date);
                    const filterDate = new Date(dateFrom);
                    matchesDate = noteDate >= filterDate;
                }
                
                return matchesSearch && matchesType && matchesDeal && matchesDate;
            });
            
            const notesList = document.getElementById('notesOverviewList');
            const notesCount = document.getElementById('notesCount');
            
            if (!notesList || !notesCount) return;
            
            if (filteredNotes.length === 0) {
                notesCount.textContent = 'No notes match your filters';
                notesList.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <h3>No matching notes found</h3>
                        <p>Try adjusting your filter criteria</p>
                    </div>
                `;
                return;
            }
            
            notesCount.textContent = `Found ${filteredNotes.length} note${filteredNotes.length !== 1 ? 's' : ''}`;
            
            // Sort filtered notes by date (most recent first)
            const sortedNotes = filteredNotes.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            notesList.innerHTML = sortedNotes.map(note => {
                // Find the associated investor
                const investor = allInvestors.find(inv => 
                    generateContactId(inv) === note.contactid || generateContactId(inv) === note.contact_id
                );
                const investorName = investor ? (investor.investor || investor.name || 'Unknown') : 'Unknown Family Office';
                
                const noteTypeIcons = {
                    call: '📞',
                    email: '📧',
                    meeting: '🤝',
                    other: '📋'
                };

                const formattedDate = new Date(note.date).toLocaleDateString();
                const formattedTime = new Date(note.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

                return `
                    <div class="note-card">
                        <div class="note-header">
                            <div style="font-weight: 600; font-size: 1.1rem; color: var(--text-primary);">
                                🏢 ${sanitizeInput(investorName)}
                            </div>
                        </div>
                        <div class="note-meta">
                            <span class="note-type-badge">
                                ${noteTypeIcons[note.notetype || note.type] || '📋'} ${(note.notetype || note.type || 'Note').charAt(0).toUpperCase() + (note.notetype || note.type || 'note').slice(1)}
                            </span>
                            ${(note.dealname || note.dealName) ? `<span class="note-deal-badge">💼 ${sanitizeInput(note.dealname || note.dealName)}</span>` : ''}
                            <span>📅 ${formattedDate}</span>
                            <span>🕒 ${formattedTime}</span>
                            <span>👤 ${sanitizeInput(note.user || 'Unknown')}</span>
                        </div>
                        <div class="note-content">${sanitizeInput(note.notecontent || note.content || '')}</div>
                    </div>
                `;
            }).join('');
        }

        function refreshNotes() {
            loadNotes().then(() => {
                displayAllNotes();
                showMessage('✅ Notes refreshed!', 'success');
            });
        }

        // ====================
        // USER MANAGEMENT
        // ====================

        async function showUserManagement() {
            if (currentUser.role !== 'admin' && currentUser.role !== 'manager') {
                showMessage('❌ Access denied. Admin or Manager role required.', 'error');
                return;
            }
            
            document.getElementById('userManagementModal').classList.add('show');
            await loadUsers();
            resetSessionTimer();
        }

        function closeUserManagement() {
            document.getElementById('userManagementModal').classList.remove('show');
            editingUserEmail = null;
        }

        async function loadUsers() {
            try {
                console.log('Loading users...');
                const result = await makeJSONPRequest('getUsers');
                
                if (result.error) {
                    throw new Error(result.error);
                }
                
                allUsers = result.users || [];
                filteredUsers = [...allUsers];
                
                console.log(`Loaded ${allUsers.length} users`);
                filterUsers();
                
            } catch (error) {
                console.error('Error loading users:', error);
                showMessage(`❌ Failed to load users: ${error.message}`, 'error');
                allUsers = [];
                filteredUsers = [];
                displayUsers([]);
            }
        }

        function filterUsers() {
            const searchTerm = document.getElementById('userSearch')?.value.toLowerCase() || '';
            const roleFilter = document.getElementById('userFilterRole')?.value || '';
            
            filteredUsers = allUsers.filter(user => {
                const matchesSearch = !searchTerm || 
                    user.name.toLowerCase().includes(searchTerm) ||
                    user.email.toLowerCase().includes(searchTerm) ||
                    user.department.toLowerCase().includes(searchTerm);
                
                const matchesRole = !roleFilter || user.role === roleFilter;
                
                return matchesSearch && matchesRole;
            });
            
            displayUsers(filteredUsers);
        }

        function displayUsers(users) {
            const usersList = document.getElementById('usersList');
            
            if (!usersList) return;
            
            if (!users || users.length === 0) {
                usersList.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <h4>👥 No users found</h4>
                        <p>No users match the current filter criteria</p>
                    </div>
                `;
                return;
            }
            
            const tableHtml = `
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="border-bottom: 2px solid #dee2e6;">
                            <th style="padding: 12px; text-align: left; background: #f8f9fa; font-weight: 600; color: #495057;">Status</th>
                            <th style="padding: 12px; text-align: left; background: #f8f9fa; font-weight: 600; color: #495057;">Name</th>
                            <th style="padding: 12px; text-align: left; background: #f8f9fa; font-weight: 600; color: #495057;">Email</th>
                            <th style="padding: 12px; text-align: left; background: #f8f9fa; font-weight: 600; color: #495057;">Role</th>
                            <th style="padding: 12px; text-align: left; background: #f8f9fa; font-weight: 600; color: #495057;">Department</th>
                            <th style="padding: 12px; text-align: left; background: #f8f9fa; font-weight: 600; color: #495057;">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${users.map(user => `
                            <tr style="border-bottom: 1px solid #e9ecef;">
                                <td style="padding: 12px;">
                                    <span style="font-size: 1.2em;">${user.active ? '🟢' : '🔴'}</span>
                                </td>
                                <td style="padding: 12px; font-weight: 600;">${sanitizeInput(user.name)}</td>
                                <td style="padding: 12px;">${sanitizeInput(user.email)}</td>
                                <td style="padding: 12px;">
                                    <span style="background: ${getRoleColor(user.role)}; color: white; padding: 4px 8px; border-radius: 12px; font-size: 0.8em;">
                                        ${user.role.charAt(0).toUpperCase() + user.role.slice(1)}
                                    </span>
                                </td>
                                <td style="padding: 12px;">${sanitizeInput(user.department)}</td>
                                <td style="padding: 12px;">
                                    <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                                        ${user.email !== currentUser.email ? `
                                            <button class="btn btn-secondary" onclick="toggleUserStatus('${user.email}', ${user.active})" style="padding: 4px 8px; font-size: 0.8em;">
                                                ${user.active ? '🚫 Deactivate' : '✅ Activate'}
                                            </button>
                                        ` : ''}
                                    </div>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            usersList.innerHTML = tableHtml;
        }

        function getRoleColor(role) {
            const colors = {
                admin: '#dc3545',
                manager: '#28a745',
                user: '#6c757d'
            };
            return colors[role] || '#6c757d';
        }

        async function showAddUser() {
            // Check permissions
            if (currentUser.role !== 'admin' && currentUser.role !== 'manager') {
                showMessage('❌ Access denied. Admin or Manager role required to add users.', 'error');
                return;
            }
            
            // Reset form
            document.getElementById('addUserForm').reset();
            document.getElementById('newUserActive').checked = true;
            document.getElementById('addUserError').style.display = 'none';
            
            // Reset password requirements display
            document.getElementById('newUserPasswordRequirements').innerHTML = `
                <div style="color: #dc3545;">❌ At least 12 characters</div>
                <div style="color: #dc3545;">❌ One uppercase letter</div>
                <div style="color: #dc3545;">❌ One lowercase letter</div>
                <div style="color: #dc3545;">❌ One number</div>
                <div style="color: #dc3545;">❌ One special character</div>
            `;
            
            // Show modal
            document.getElementById('addUserModal').classList.add('show');
            resetSessionTimer();
        }

        function closeAddUser() {
            document.getElementById('addUserModal').classList.remove('show');
        }

        function checkNewUserPasswordStrength() {
            const password = document.getElementById('newUserPassword').value;
            const requirements = document.getElementById('newUserPasswordRequirements');
            
            if (!password) {
                requirements.innerHTML = `
                    <div style="color: #dc3545;">❌ At least 12 characters</div>
                    <div style="color: #dc3545;">❌ One uppercase letter</div>
                    <div style="color: #dc3545;">❌ One lowercase letter</div>
                    <div style="color: #dc3545;">❌ One number</div>
                    <div style="color: #dc3545;">❌ One special character</div>
                `;
                return;
            }
            
            const validation = validatePasswordStrength(password);
            
            requirements.innerHTML = `
                <div style="color: ${validation.requirements.length ? '#28a745' : '#dc3545'};">${validation.requirements.length ? '✅' : '❌'} At least 12 characters</div>
                <div style="color: ${validation.requirements.uppercase ? '#28a745' : '#dc3545'};">${validation.requirements.uppercase ? '✅' : '❌'} One uppercase letter</div>
                <div style="color: ${validation.requirements.lowercase ? '#28a745' : '#dc3545'};">${validation.requirements.lowercase ? '✅' : '❌'} One lowercase letter</div>
                <div style="color: ${validation.requirements.number ? '#28a745' : '#dc3545'};">${validation.requirements.number ? '✅' : '❌'} One number</div>
                <div style="color: ${validation.requirements.special ? '#28a745' : '#dc3545'};">${validation.requirements.special ? '✅' : '❌'} One special character</div>
            `;
        }

        async function createUser() {
            const name = document.getElementById('newUserName').value.trim();
            const email = document.getElementById('newUserEmail').value.trim();
            const role = document.getElementById('newUserRole').value;
            const department = document.getElementById('newUserDepartment').value;
            const password = document.getElementById('newUserPassword').value;
            const active = document.getElementById('newUserActive').checked;
            const errorDiv = document.getElementById('addUserError');
            const createBtn = document.getElementById('createUserBtn');

            // Clear previous errors
            errorDiv.style.display = 'none';

            // Validation
            if (!name || !email || !role || !department || !password) {
                errorDiv.textContent = 'Please fill in all required fields';
                errorDiv.style.display = 'block';
                return;
            }

            // Email validation
            if (!email.includes('@') || !email.includes('.')) {
                errorDiv.textContent = 'Please enter a valid email address';
                errorDiv.style.display = 'block';
                return;
            }

            // Password validation
            const passwordValidation = validatePasswordStrength(password);
            if (passwordValidation.score < 5) {
                errorDiv.textContent = 'Password does not meet all security requirements';
                errorDiv.style.display = 'block';
                return;
            }

            // Check if email already exists
            const existingUser = allUsers.find(user => user.email.toLowerCase() === email.toLowerCase());
            if (existingUser) {
                errorDiv.textContent = 'A user with this email address already exists';
                errorDiv.style.display = 'block';
                return;
            }

            // Disable button and show loading
            createBtn.disabled = true;
            createBtn.classList.add('btn-loading');
            createBtn.textContent = 'Creating...';

            try {
                console.log('Creating new user:', { name, email, role, department, active });

                const result = await makeJSONPRequest('addUser', {
                    name: name,
                    email: email,
                    role: role,
                    department: department,
                    password: password,
                    active: active,
                    createdBy: currentUser.email,
                    requirePasswordChange: true
                });

                console.log('Add user result:', result);

                if (result.success) {
                    closeAddUser();
                    showMessage(`✅ User "${name}" created successfully!`, 'success');
                    
                    // Reload users to show the new user
                    await loadUsers();
                } else {
                    throw new Error(result.error || 'Failed to create user');
                }

            } catch (error) {
                console.error('Error creating user:', error);
                errorDiv.textContent = error.message;
                errorDiv.style.display = 'block';
            } finally {
                createBtn.disabled = false;
                createBtn.classList.remove('btn-loading');
                createBtn.textContent = '➕ Create User';
            }
        }

        async function toggleUserStatus(email, currentStatus) {
            showMessage('User status toggle functionality coming soon!', 'info');
        }

        // ====================
        // PASSWORD MANAGEMENT
        // ====================

        function changePassword() {
            document.getElementById('changePasswordModal').classList.add('show');
            resetSessionTimer();
        }

        function closeChangePassword() {
            const modal = document.getElementById('changePasswordModal');
            if (modal) {
                modal.classList.remove('show');
                document.getElementById('currentPassword').value = '';
                document.getElementById('newPassword').value = '';
                document.getElementById('confirmPassword').value = '';
            }
        }

        async function updatePassword() {
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const updateButton = document.getElementById('updatePasswordBtn');

            // Validation
            if (!currentPassword || !newPassword || !confirmPassword) {
                showMessage('❌ Please fill in all password fields', 'error');
                return;
            }

            if (newPassword !== confirmPassword) {
                showMessage('❌ New passwords do not match', 'error');
                return;
            }

            if (currentPassword === newPassword) {
                showMessage('❌ New password must be different from current password', 'error');
                return;
            }

            const passwordValidation = validatePasswordStrength(newPassword);
            if (passwordValidation.score < 5) {
                showMessage('❌ New password does not meet all security requirements', 'error');
                return;
            }

            updateButton.disabled = true;
            updateButton.classList.add('btn-loading');
            updateButton.textContent = 'Updating...';

            try {
                const result = await makeJSONPRequest('changePasswordEnhanced', {
                    email: currentUser.email,
                    currentPassword: currentPassword,
                    newPassword: newPassword,
                    logoutOthers: false
                });

                if (result.success) {
                    closeChangePassword();
                    showMessage('✅ Password updated successfully!', 'success');
                    
                    // Clear password fields
                    document.getElementById('currentPassword').value = '';
                    document.getElementById('newPassword').value = '';
                    document.getElementById('confirmPassword').value = '';
                } else {
                    showMessage(`❌ ${result.error}`, 'error');
                }

            } catch (error) {
                showMessage(`❌ Failed to update password: ${error.message}`, 'error');
            } finally {
                updateButton.disabled = false;
                updateButton.classList.remove('btn-loading');
                updateButton.textContent = '🔐 Update Password';
            }
        }

        function validatePasswordStrength(password) {
            const requirements = {
                length: password.length >= 12,
                uppercase: /[A-Z]/.test(password),
                lowercase: /[a-z]/.test(password),
                number: /\d/.test(password),
                special: /[!@#$%^&*(),.?":{}|<>]/.test(password)
            };
            
            const score = Object.values(requirements).filter(Boolean).length;
            
            return { requirements, score };
        }

        function checkPasswordStrength() {
            const password = document.getElementById('newPassword').value;
            const requirements = document.getElementById('passwordRequirements');
            
            if (!password) {
                requirements.innerHTML = `
                    <div style="color: #dc3545;">❌ At least 12 characters</div>
                    <div style="color: #dc3545;">❌ One uppercase letter</div>
                    <div style="color: #dc3545;">❌ One lowercase letter</div>
                    <div style="color: #dc3545;">❌ One number</div>
                    <div style="color: #dc3545;">❌ One special character</div>
                `;
                return;
            }
            
            const validation = validatePasswordStrength(password);
            
            requirements.innerHTML = `
                <div style="color: ${validation.requirements.length ? '#28a745' : '#dc3545'};">${validation.requirements.length ? '✅' : '❌'} At least 12 characters</div>
                <div style="color: ${validation.requirements.uppercase ? '#28a745' : '#dc3545'};">${validation.requirements.uppercase ? '✅' : '❌'} One uppercase letter</div>
                <div style="color: ${validation.requirements.lowercase ? '#28a745' : '#dc3545'};">${validation.requirements.lowercase ? '✅' : '❌'} One lowercase letter</div>
                <div style="color: ${validation.requirements.number ? '#28a745' : '#dc3545'};">${validation.requirements.number ? '✅' : '❌'} One number</div>
                <div style="color: ${validation.requirements.special ? '#28a745' : '#dc3545'};">${validation.requirements.special ? '✅' : '❌'} One special character</div>
            `;
            
            checkPasswordMatch();
        }

        function checkPasswordMatch() {
            const password = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const confirmMatch = document.getElementById('confirmMatch');
            
            if (!confirmPassword) {
                confirmMatch.textContent = '';
                return;
            }
            
            if (password === confirmPassword) {
                confirmMatch.textContent = '✅ Passwords match';
                confirmMatch.style.color = '#28a745';
            } else {
                confirmMatch.textContent = '❌ Passwords do not match';
                confirmMatch.style.color = '#dc3545';
            }
        }

        // ====================
        // EVENT LISTENERS
        // ====================

        document.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                if (e.target.closest('.login-form')) {
                    login();
                } else if (e.target.closest('.search-section')) {
                    searchInvestors();
                }
            }
        });

        // Reset session timer on user activity
        document.addEventListener('click', resetSessionTimer);
        document.addEventListener('keypress', resetSessionTimer);

        // Close modals when clicking outside
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('modal')) {
                if (e.target.id === 'notesModal') closeNotesModal();
                if (e.target.id === 'changePasswordModal') closeChangePassword();
                if (e.target.id === 'userManagementModal') closeUserManagement();
                if (e.target.id === 'addUserModal') closeAddUser();
            }
        });

        // Close theme panel when clicking outside
        document.addEventListener('click', function(e) {
            const panel = document.getElementById('themePanel');
            
            if (panel && !panel.contains(e.target) && panel.classList.contains('open')) {
                // Check if click was on theme toggle button
                const themeButton = e.target.closest('[onclick="toggleThemePanel()"]');
                if (!themeButton) {
                    panel.classList.remove('open');
                }
            }
        });

        // ====================
        // INITIALIZATION
        // ====================

        document.addEventListener('DOMContentLoaded', function() {
            console.log('🔐 Unified Family Office CRM Initialized');
            
            if (!CONFIG.apiUrl) {
                alert('Configuration error: API URL not defined');
                return;
            }
            
            // Load saved theme
            ThemeManager.loadTheme();
            
            // Show login modal
            document.getElementById('loginModal').style.display = 'flex';
            
            // Set saved page size
            const savedPageSize = localStorage.getItem('crmPageSize');
            if (savedPageSize) {
                pageSize = parseInt(savedPageSize);
            }

            // Update session info every minute
            setInterval(updateSessionInfo, 60000);

            debugLog('Script loaded successfully');
        });
    </script>
</body>
</html>