<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Family Office CRM - Secure</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        /* Login Modal Styles */
        .login-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .login-form {
            background: white;
            padding: 40px;
            border-radius: 20px;
            width: 90%;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        .login-form h2 {
            color: #2c3e50;
            margin-bottom: 30px;
            font-size: 1.8em;
        }

        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .form-group label {
            font-weight: 600;
            color: #495057;
            margin-bottom: 5px;
            display: block;
            font-size: 0.9em;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 1em;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #282828;
            box-shadow: 0 0 0 3px rgba(40, 40, 40, 0.1);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        /* Header Styles */
        .header {
            margin-bottom: 30px;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 20px;
        }

        .header-left {
            display: flex;
            align-items: center;
            flex: 1;
            min-width: 300px;
        }

        .header-logo {
            width: 60px;
            height: 30px;
            margin-right: 15px;
            flex-shrink: 0;
        }

        .header h1 {
            color: #2c3e50;
            font-size: 2.5em;
            margin-bottom: 5px;
        }

        .header p {
            color: #666;
            font-size: 1.1em;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
            color: #495057;
            font-weight: 600;
            flex-wrap: wrap;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #282828;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            flex-shrink: 0;
        }

        .user-details {
            display: flex;
            flex-direction: column;
            min-width: 120px;
        }

        .session-info {
            font-size: 0.7em;
            color: #666;
            margin-top: 2px;
        }

        .user-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        /* Search Section */
        .search-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            border: 2px solid #e9ecef;
        }

        .search-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
            align-items: end;
        }

        /* Button Styles */
        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 0.9em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
            position: relative;
            white-space: nowrap;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        .btn-primary {
            background: #282828;
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(40, 40, 40, 0.4);
            background: #333333;
        }

        .btn-secondary {
            background: #48494B;
            color: white;
        }

        .btn-secondary:hover:not(:disabled) {
            background: #5a5b5d;
            transform: translateY(-2px);
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover:not(:disabled) {
            background: #218838;
            transform: translateY(-2px);
        }

        .btn-loading::after {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            margin: auto;
            border: 2px solid transparent;
            border-top-color: #ffffff;
            border-radius: 50%;
            animation: button-loading-spinner 1s ease infinite;
            left: 0;
            right: 0;
            top: 0;
            bottom: 0;
        }

        @keyframes button-loading-spinner {
            from { transform: rotate(0turn); }
            to { transform: rotate(1turn); }
        }

        /* Pagination Styles */
        .pagination-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 12px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .pagination-info {
            color: #495057;
            font-weight: 600;
            order: 1;
        }

        .pagination-buttons {
            display: flex;
            gap: 8px;
            align-items: center;
            order: 3;
            flex-wrap: wrap;
        }

        .pagination-buttons button {
            padding: 8px 12px;
            border: 1px solid #dee2e6;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9em;
        }

        .pagination-buttons button:hover:not(:disabled) {
            background: #282828;
            color: white;
        }

        .pagination-buttons button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .page-size-selector {
            display: flex;
            align-items: center;
            gap: 10px;
            order: 2;
        }

        .page-size-selector select {
            padding: 8px 12px;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            background: white;
        }

        .sort-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            order: 4;
            flex-wrap: wrap;
        }

        .sort-button {
            padding: 8px 16px;
            border: 1px solid #dee2e6;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.9em;
        }

        .sort-button.active {
            background: #282828;
            color: white;
        }

        .sort-button:hover {
            background: #f8f9fa;
        }

        .sort-button.active:hover {
            background: #333333;
        }

        /* Investor Card Styles */
        .investor-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
            gap: 20px;
        }

        .investor-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .investor-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: #282828;
        }

        .investor-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            border-color: #282828;
        }

        .investor-name {
            font-size: 1.4em;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 12px;
            padding-right: 80px;
        }

        .investor-detail {
            margin-bottom: 8px;
            display: flex;
            align-items: flex-start;
            gap: 8px;
        }

        .investor-detail strong {
            color: #495057;
            min-width: 80px;
            font-size: 0.9em;
            flex-shrink: 0;
        }

        .investor-detail span {
            color: #6c757d;
            flex: 1;
            word-break: break-word;
        }

        /* Status Messages */
        .status-message {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 600;
            text-align: center;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .status-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        /* Security Alert Styles */
        .security-alert {
            background: #f8d7da;
            border: 2px solid #dc3545;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            color: #721c24;
        }

        .security-alert h4 {
            margin-bottom: 10px;
            color: #dc3545;
        }

        .security-alert ul {
            margin-left: 20px;
        }

        .security-alert li {
            margin-bottom: 5px;
        }

        /* Modal Styles */
        .notes-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1001;
            padding: 20px;
        }

        .notes-modal.show {
            display: flex;
        }

        .notes-content {
            background: white;
            border-radius: 20px;
            width: 90%;
            max-width: 900px;
            max-height: 85vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
            position: relative;
        }

        .large-modal .notes-content {
            max-width: 1200px;
        }

        .notes-header {
            padding: 25px;
            border-bottom: 2px solid #e9ecef;
            background: #f8f9fa;
            flex-shrink: 0;
        }

        .notes-header h3 {
            color: #2c3e50;
            margin-bottom: 5px;
            font-size: 1.4em;
        }

        .notes-header p {
            color: #666;
            font-size: 0.9em;
        }

        .notes-body {
            flex: 1;
            overflow-y: auto;
            padding: 0;
        }

        .add-note-section {
            padding: 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }

        .add-note-form {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .note-text-area {
            grid-column: 1 / -1;
        }

        .notes-list {
            padding: 20px;
        }

        .note-item {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }

        .note-item:hover {
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            border-color: #282828;
        }

        .note-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .note-meta {
            display: flex;
            gap: 15px;
            align-items: center;
            font-size: 0.85em;
            color: #666;
            flex-wrap: wrap;
        }

        .note-type {
            background: #282828;
            color: white;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: 600;
        }

        .deal-tag {
            background: #667eea;
            color: white;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: 600;
        }

        .note-content {
            color: #495057;
            line-height: 1.5;
        }

        .empty-notes {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .notes-button {
            position: absolute;
            top: 15px;
            right: 15px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 0.8em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .notes-button:hover {
            background: #5a67d8;
            transform: scale(1.05);
        }

        .notes-count {
            background: rgba(255, 255, 255, 0.3);
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.9em;
        }

        /* Tags */
        .tags {
            margin-top: 15px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .tag {
            background: #282828;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 500;
        }

        /* Contacts Section */
        .contacts-section {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }

        .contacts-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .contact {
            background: #f8f9fa;
            padding: 8px;
            border-radius: 6px;
            font-size: 0.85em;
        }

        .contact-name {
            font-weight: 600;
            color: #495057;
            margin-bottom: 4px;
        }

        .contact-detail {
            font-size: 0.8em;
            color: #6c757d;
            margin-bottom: 2px;
        }

        .close-modal {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: #666;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            z-index: 10;
        }

        .close-modal:hover {
            background: #f0f0f0;
            color: #333;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .loading::after {
            content: '⏳';
            font-size: 2em;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Password strength styles */
        .password-requirements {
            font-size: 0.8em;
            color: #666;
            margin-top: 5px;
            text-align: left;
        }

        .requirement {
            margin: 3px 0;
            transition: color 0.3s ease;
        }

        .password-strength {
            height: 4px;
            background: #e9ecef;
            border-radius: 2px;
            margin-top: 5px;
            overflow: hidden;
        }

        .password-strength-bar {
            height: 100%;
            width: 0%;
            transition: all 0.3s ease;
            border-radius: 2px;
        }

        .strength-weak { background: #dc3545; width: 25%; }
        .strength-fair { background: #ffc107; width: 50%; }
        .strength-good { background: #28a745; width: 75%; }
        .strength-strong { background: #20c997; width: 100%; }

        /* User management table */
        .user-management-table {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
            text-align: left;
            padding: 12px;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid #e9ecef;
        }

        tr:hover {
            background: #f8f9fa;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
                margin: 10px;
            }
            
            .header-content {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }

            .header h1 {
                font-size: 1.8em;
            }
            
            .search-row {
                grid-template-columns: 1fr;
            }
            
            .investor-grid {
                grid-template-columns: 1fr;
            }

            .contacts-grid {
                grid-template-columns: 1fr;
            }

            .add-note-form {
                grid-template-columns: 1fr;
            }

            .notes-content {
                width: 95%;
                max-height: 90vh;
            }

            .pagination-controls {
                flex-direction: column;
                gap: 15px;
            }

            .pagination-info {
                order: 1;
                text-align: center;
            }

            .page-size-selector {
                order: 2;
                justify-content: center;
            }

            .pagination-buttons {
                order: 3;
                justify-content: center;
            }

            .sort-controls {
                order: 4;
                justify-content: center;
                width: 100%;
            }

            .user-management-table {
                font-size: 0.8em;
            }
            
            .user-management-table th,
            .user-management-table td {
                padding: 6px;
            }
        }
    </style>
</head>
<body>
    <!-- Login Modal -->
    <div class="login-modal" id="loginModal">
        <div class="login-form">
            <h2>🔐 Secure Family Office CRM</h2>
            <p style="color: #666; margin-bottom: 30px;">Please sign in to continue</p>
            
            <div class="form-group">
                <label for="loginEmail">Email Address</label>
                <input type="email" id="loginEmail" placeholder="Enter your email" required autocomplete="email">
            </div>
            
            <div class="form-group">
                <label for="loginPassword">Password</label>
                <input type="password" id="loginPassword" placeholder="Enter your password" required autocomplete="current-password">
            </div>
            
            <div style="margin-top: 30px;">
                <button class="btn btn-primary" id="loginButton" onclick="login()" style="width: 100%;">
                    <span id="loginButtonText">Sign In</span>
                </button>
            </div>
            
            <div id="loginError" style="color: #dc3545; margin-top: 15px; font-size: 0.9em;"></div>
            
            <div style="margin-top: 20px; font-size: 0.8em; color: #666;">
                <p>🔒 Your connection is secured with enterprise-grade encryption</p>
            </div>
        </div>
    </div>

    <!-- Main Application -->
    <div class="container" id="mainApp" style="display: none;">
        <!-- Security Alert -->
        <div class="security-alert" id="securityAlert">
            <h4>🚨 SECURITY NOTICE - DEVELOPMENT VERSION</h4>
            <p><strong>This is a development version with security limitations. Before going live, implement:</strong></p>
            <ul>
                <li>Server-side password hashing (bcrypt/scrypt)</li>
                <li>JWT tokens or proper session management</li>
                <li>Rate limiting on login attempts</li>
                <li>HTTPS enforcement</li>
                <li>Environment variables for API URLs</li>
                <li>Input validation and sanitization</li>
            </ul>
            <button class="btn btn-secondary" onclick="hideSecurityAlert()" style="margin-top: 10px; font-size: 0.8em;">
                I understand - Hide Alert
            </button>
        </div>

        <div class="header">
            <div class="header-content">
                <div class="header-left">
                    <div class="header-logo">
                        <svg viewBox="0 0 200 100" xmlns="http://www.w3.org/2000/svg">
                            <defs>
                                <style>
                                    .logo-black { fill: #282828; }
                                    .logo-white { fill: #f8f9fa; }
                                </style>
                            </defs>
                            <path d="M 20 100 A 80 80 0 0 1 180 100 Z" class="logo-black"/>
                            <g stroke="#282828" stroke-width="1.5" fill="none">
                                <line x1="100" y1="100" x2="100" y2="20"/>
                                <line x1="100" y1="100" x2="74" y2="25"/>
                                <line x1="100" y1="100" x2="126" y2="25"/>
                                <line x1="100" y1="100" x2="52" y2="36"/>
                                <line x1="100" y1="100" x2="148" y2="36"/>
                                <line x1="100" y1="100" x2="35" y2="55"/>
                                <line x1="100" y1="100" x2="165" y2="55"/>
                                <line x1="100" y1="100" x2="25" y2="78"/>
                                <line x1="100" y1="100" x2="175" y2="78"/>
                                <path d="M 60 100 A 40 40 0 0 1 140 100"/>
                                <path d="M 40 100 A 60 60 0 0 1 160 100"/>
                            </g>
                            <circle cx="100" cy="100" r="12" class="logo-white" stroke="#282828" stroke-width="1"/>
                        </svg>
                    </div>
                    <div>
                        <h1>Family Office CRM</h1>
                        <p>Secure European Family Office Database</p>
                    </div>
                </div>
                <div class="user-info">
                    <div class="user-avatar" id="userAvatar">U</div>
                    <div class="user-details">
                        <div id="userName">User</div>
                        <div style="font-size: 0.8em; color: #666;" id="userRole">Role</div>
                        <div class="session-info" id="sessionInfo">Session active</div>
                    </div>
                    <div class="user-actions">
                        <button class="btn btn-secondary" onclick="showUserManagement()" id="userMgmtBtn" style="display: none;">
                            👥 Users
                        </button>
                        <button class="btn btn-secondary" onclick="testAPIConnection()" id="debugTestBtn">
                            🔧 Test
                        </button>
                        <button class="btn btn-secondary" onclick="changePassword()" id="changePasswordBtn">
                            🔑 Password
                        </button>
                        <button class="btn btn-secondary" onclick="logout()">
                            🚪 Logout
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Search Section -->
        <div class="search-section">
            <h3 style="margin-bottom: 20px; color: #495057;">🔍 Search Family Offices</h3>
            
            <div class="search-row">
                <div class="form-group">
                    <label for="searchName">Family Office Name</label>
                    <input type="text" id="searchName" placeholder="Enter name...">
                </div>
                
                <div class="form-group">
                    <label for="searchCountry">Country</label>
                    <select id="searchCountry">
                        <option value="">All Countries</option>
                    </select>
                </div>
            </div>

            <div class="search-row">
                <div class="form-group">
                    <label for="searchIndustry">Industry</label>
                    <select id="searchIndustry">
                        <option value="">All Industries</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="searchStage">Investment Stage</label>
                    <select id="searchStage">
                        <option value="">All Stages</option>
                    </select>
                </div>
            </div>

            <div class="search-row">
                <div class="form-group">
                    <label for="searchOwner">Owner</label>
                    <select id="searchOwner">
                        <option value="">All Owners</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="searchDeal">Deal Name</label>
                    <select id="searchDeal">
                        <option value="">All Deals</option>
                    </select>
                </div>
            </div>
            
            <div class="button-group">
                <button class="btn btn-primary" onclick="searchInvestors()">🔍 Search</button>
                <button class="btn btn-secondary" onclick="clearSearch()">Clear</button>
                <button class="btn btn-secondary" onclick="refreshData()">🔄 Refresh Data</button>
            </div>
        </div>

        <!-- Status Messages -->
        <div id="statusMessage"></div>

        <!-- Results Section -->
        <div class="results-section">
            <div class="results-header">
                <div class="results-count" id="resultsCount">Loading family offices...</div>
            </div>
            
            <!-- Pagination Controls Top -->
            <div class="pagination-controls" id="topPagination">
                <div class="pagination-info" id="paginationInfo">
                    Showing 1-30 of 0 results
                </div>
                <div class="page-size-selector">
                    <label>Show:</label>
                    <select id="pageSize" onchange="changePageSize()">
                        <option value="10">10 per page</option>
                        <option value="30" selected>30 per page</option>
                        <option value="50">50 per page</option>
                        <option value="100">100 per page</option>
                    </select>
                </div>
                <div class="pagination-buttons" id="paginationButtons">
                    <button onclick="goToPage(1)" disabled>First</button>
                    <button onclick="previousPage()" disabled>Previous</button>
                    <span id="pageNumbers"></span>
                    <button onclick="nextPage()" disabled>Next</button>
                    <button onclick="goToPage('last')" disabled>Last</button>
                </div>
                <div class="sort-controls">
                    <button class="sort-button active" id="sortDefault" onclick="sortInvestors('default')">
                        Default Order
                    </button>
                    <button class="sort-button" id="sortAlpha" onclick="sortInvestors('alpha')">
                        A-Z ↓
                    </button>
                </div>
            </div>
            
            <div id="loadingIndicator" class="loading" style="display: none;">Loading family offices</div>
            
            <div class="investor-grid" id="investorGrid">
                <!-- Results will be populated here -->
            </div>
            
            <div class="pagination-controls" id="bottomPagination" style="margin-top: 20px;">
                <!-- Pagination controls will be cloned here -->
            </div>
        </div>
    </div>

    <!-- Notes Modal -->
    <div class="notes-modal" id="notesModal">
        <div class="notes-content">
            <button class="close-modal" onclick="closeNotesModal()">×</button>
            <div class="notes-header">
                <h3 id="notesModalTitle">Notes for Family Office</h3>
                <p id="notesModalSubtitle">Manage your interactions and follow-ups</p>
            </div>
            
            <div class="notes-body">
                <!-- Add Note Section -->
                <div class="add-note-section">
                    <h4 style="margin-bottom: 15px; color: #495057;">📝 Add New Note</h4>
                    <div class="add-note-form">
                        <div class="form-group">
                            <label>Note Type</label>
                            <select id="noteType">
                                <option value="call">📞 Call</option>
                                <option value="email">📧 Email</option>
                                <option value="meeting">🤝 Meeting</option>
                                <option value="other">📋 Other</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>Deal Name</label>
                            <select id="dealName" onchange="handleDealSelection()">
                                <option value="">Select existing deal or create new...</option>
                                <option value="__create_new__">➕ Create New Deal</option>
                            </select>
                            <input type="text" id="dealNameInput" placeholder="Enter new deal name..." style="display: none; margin-top: 8px;">
                        </div>
                        
                        <div class="form-group">
                            <label>Date</label>
                            <input type="date" id="noteDate">
                        </div>
                        
                        <div class="note-text-area">
                            <label>Note Content</label>
                            <textarea id="noteContent" placeholder="Enter your note here..."></textarea>
                        </div>
                    </div>
                    
                    <button class="btn btn-success" onclick="addNote()">💾 Save Note</button>
                </div>
                
                <!-- Notes List -->
                <div class="notes-list" id="notesList">
                    <!-- Notes will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- User Management Modal -->
    <div class="notes-modal large-modal" id="userManagementModal">
        <div class="notes-content">
            <button class="close-modal" onclick="closeUserManagement()">×</button>
            <div class="notes-header">
                <h3>👥 User Management</h3>
                <p>Manage system users, roles, and permissions</p>
            </div>
            
            <div class="notes-body">
                <!-- User List View -->
                <div id="userListView">
                    <!-- Controls -->
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 0 20px; flex-wrap: wrap; gap: 10px;">
                        <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                            <input type="text" id="userSearch" placeholder="Search users..." style="padding: 8px 12px; border: 2px solid #dee2e6; border-radius: 8px; width: 200px; min-width: 150px;" oninput="filterUsers()">
                            <select id="userFilterRole" style="padding: 8px 12px; border: 2px solid #dee2e6; border-radius: 8px;" onchange="filterUsers()">
                                <option value="">All Roles</option>
                                <option value="admin">Admin</option>
                                <option value="manager">Manager</option>
                                <option value="user">User</option>
                            </select>
                            <select id="userFilterStatus" style="padding: 8px 12px; border: 2px solid #dee2e6; border-radius: 8px;" onchange="filterUsers()">
                                <option value="">All Status</option>
                                <option value="active">Active</option>
                                <option value="inactive">Inactive</option>
                            </select>
                        </div>
                        <button class="btn btn-success" onclick="showAddUser()">➕ Add New User</button>
                    </div>
                    
                    <!-- Users Table -->
                    <div style="padding: 0 20px;">
                        <div id="usersList" class="user-management-table" style="max-height: 400px; overflow-y: auto;">
                            <!-- Users will be populated here -->
                        </div>
                    </div>
                </div>
                
                <!-- Add/Edit User Form -->
                <div id="userFormView" style="display: none; padding: 20px;">
                    <button class="btn btn-secondary" onclick="showUserList()" style="margin-bottom: 20px;">← Back to Users</button>
                    
                    <h4 id="userFormTitle" style="margin-bottom: 20px; color: #495057;">Add New User</h4>
                    
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 12px;">
                        <h5 style="margin-bottom: 15px; color: #495057;">Personal Information</h5>
                        <div class="add-note-form">
                            <div class="form-group">
                                <label>Full Name*</label>
                                <input type="text" id="userFormName" placeholder="Enter full name..." required>
                            </div>
                            
                            <div class="form-group">
                                <label>Email Address*</label>
                                <input type="email" id="userFormEmail" placeholder="Enter email address..." required>
                                <div id="emailValidation" style="font-size: 0.8em; margin-top: 5px;"></div>
                            </div>
                            
                            <div class="form-group">
                                <label>Department*</label>
                                <select id="userFormDepartment" required>
                                    <option value="">Select department...</option>
                                    <option value="Investment">Investment</option>
                                    <option value="Research">Research</option>
                                    <option value="Operations">Operations</option>
                                    <option value="Administration">Administration</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label>Role*</label>
                                <select id="userFormRole">
                                    <option value="user">User</option>
                                    <option value="manager">Manager</option>
                                    <option value="admin">Admin</option>
                                </select>
                            </div>
                        </div>
                        
                        <div id="passwordSection" style="margin-top: 20px;">
                            <h5 style="margin-bottom: 15px; color: #495057;">Security Settings</h5>
                            <button class="btn btn-secondary" onclick="generatePassword()" style="margin-bottom: 15px; font-size: 0.9em;">
                                ⚡ Generate Secure Password
                            </button>
                            
                            <div class="form-group">
                                <label>Temporary Password*</label>
                                <div style="position: relative;">
                                    <input type="password" id="userFormPassword" placeholder="Enter secure password..." required minlength="12" oninput="checkUserPasswordStrength()">
                                    <button type="button" onclick="togglePasswordVisibility('userFormPassword')" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer;">
                                        👁
                                    </button>
                                </div>
                                <div class="password-requirements">
                                    <div id="passwordRequirements">
                                        <div class="requirement" data-req="length">❌ At least 12 characters</div>
                                        <div class="requirement" data-req="uppercase">❌ One uppercase letter</div>
                                        <div class="requirement" data-req="lowercase">❌ One lowercase letter</div>
                                        <div class="requirement" data-req="number">❌ One number</div>
                                        <div class="requirement" data-req="special">❌ One special character</div>
                                    </div>
                                </div>
                                <div class="password-strength">
                                    <div class="password-strength-bar" id="userPasswordStrength"></div>
                                </div>
                            </div>
                            
                            <div style="margin-top: 15px;">
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="checkbox" id="forcePasswordChange" checked>
                                    Force password change on first login
                                </label>
                            </div>
                        </div>
                        
                        <div style="margin-top: 20px;">
                            <h5 style="margin-bottom: 15px; color: #495057;">Account Settings</h5>
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="checkbox" id="userFormActive" checked>
                                Active Account
                            </label>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button class="btn btn-secondary" onclick="showUserList()">Cancel</button>
                        <button class="btn btn-success" onclick="saveUser()" id="saveUserBtn">Save User</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Change Password Modal -->
    <div class="notes-modal" id="changePasswordModal">
        <div class="notes-content" style="max-width: 500px;">
            <button class="close-modal" onclick="closeChangePassword()">×</button>
            <div class="notes-header">
                <h3>🔑 Change Password</h3>
                <p>Update your account password</p>
            </div>
            
            <div class="notes-body" style="padding: 20px;">
                <div class="form-group">
                    <label>Current Password*</label>
                    <div style="position: relative;">
                        <input type="password" id="currentPassword" placeholder="Enter current password..." required>
                        <button type="button" onclick="togglePasswordVisibility('currentPassword')" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer;">
                            👁
                        </button>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>New Password*</label>
                    <div style="position: relative;">
                        <input type="password" id="newPassword" placeholder="Enter new password..." required minlength="12" oninput="checkPasswordStrength()">
                        <button type="button" onclick="togglePasswordVisibility('newPassword')" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer;">
                            👁
                        </button>
                    </div>
                    <div class="password-requirements" style="margin-top: 10px;">
                        <div class="requirement" data-req="length" style="font-size: 0.85em;">❌ At least 12 characters</div>
                        <div class="requirement" data-req="uppercase" style="font-size: 0.85em;">❌ One uppercase letter</div>
                        <div class="requirement" data-req="lowercase" style="font-size: 0.85em;">❌ One lowercase letter</div>
                        <div class="requirement" data-req="number" style="font-size: 0.85em;">❌ One number</div>
                        <div class="requirement" data-req="special" style="font-size: 0.85em;">❌ One special character</div>
                    </div>
                    <div class="password-strength">
                        <div class="password-strength-bar" id="passwordStrength"></div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Confirm New Password*</label>
                    <div style="position: relative;">
                        <input type="password" id="confirmPassword" placeholder="Confirm new password..." required oninput="checkPasswordMatch()">
                        <button type="button" onclick="togglePasswordVisibility('confirmPassword')" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer;">
                            👁
                        </button>
                    </div>
                    <div id="confirmMatch" style="font-size: 0.85em; margin-top: 5px;"></div>
                </div>
                
                <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                    <h5 style="margin-bottom: 10px; color: #495057;">Security Options</h5>
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" id="logoutOthers">
                        Logout from all other sessions
                    </label>
                </div>
                
                <button class="btn btn-success" onclick="updatePassword()" id="updatePasswordBtn" style="width: 100%; margin-top: 20px;">
                    🔐 Update Password
                </button>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const CONFIG = {
            apiUrl: 'https://script.google.com/macros/s/AKfycbxqrI_dlu82qxZ40QApEm397JXsj2oVpZwzFtJODyXeEdFSybkVU-CkYHa_8oE-RyFI/exec',
            maxLoginAttempts: 5,
            sessionTimeout: 30 * 60 * 1000, // 30 minutes
            passwordMinLength: 12
        };

        // Global variables
        let allInvestors = [];
        let filteredInvestors = [];
        let notesData = [];
        let allUsers = [];
        let filteredUsers = [];
        let currentUser = null;
        let currentContactId = null;
        let editingUserEmail = null;
        let isAuthenticated = false;
        let loginAttempts = 0;
        let sessionTimer = null;
        let currentPage = 1;
        let pageSize = parseInt(localStorage.getItem('crmPageSize') || '30');
        let sortOrder = 'default';
        let sortDirection = 'asc';

        // ====================
        // UTILITY FUNCTIONS
        // ====================

        function getInitials(name) {
            if (!name) return 'U';
            return name.split(' ').map(n => n[0]).join('').toUpperCase();
        }

        function sanitizeInput(input) {
            if (typeof input !== 'string') return input || '';
            
            return input
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#x27;')
                .replace(/\//g, '&#x2F;')
                .trim();
        }

        function generateContactId(investor) {
            const name = (investor.investor || investor.name || '').trim().toLowerCase();
            const domain = (investor.domain || investor.website || '').trim().toLowerCase();
            const country = (investor.maincountry || investor.country || '').trim().toLowerCase();
            const email = (investor.contact1email || '').trim().toLowerCase();
            
            let id = '';
            if (name) id += name.replace(/[^a-z0-9]/g, '_');
            if (domain) id += '_' + domain.replace(/[^a-z0-9]/g, '_');
            if (!id && email) id = email.replace(/[^a-z0-9]/g, '_');
            if (!id && country) id = 'contact_' + country.replace(/[^a-z0-9]/g, '_');
            
            if (!id) {
                const str = JSON.stringify(investor);
                id = 'contact_' + Math.abs(str.split('').reduce((a, b) => {
                    a = ((a << 5) - a) + b.charCodeAt(0);
                    return a & a;
                }, 0)).toString();
            }
            
            return id.substring(0, 50);
        }

        // ====================
        // API FUNCTIONS
        // ====================

        function makeJSONPRequest(action, params = {}) {
            return new Promise((resolve, reject) => {
                const callbackName = 'jsonp_callback_' + Date.now();
                
                window[callbackName] = function(data) {
                    cleanup();
                    resolve(data);
                };
                
                function cleanup() {
                    delete window[callbackName];
                    if (document.head.contains(script)) {
                        document.head.removeChild(script);
                    }
                }
                
                const script = document.createElement('script');
                const urlParams = new URLSearchParams({
                    action: action,
                    callback: callbackName,
                    timestamp: Date.now(),
                    ...params
                });
                
                script.src = `${CONFIG.apiUrl}?${urlParams.toString()}`;
                script.onerror = () => {
                    cleanup();
                    reject(new Error(`JSONP request failed for action: ${action}`));
                };
                
                const timeout = setTimeout(() => {
                    cleanup();
                    reject(new Error(`Request timeout for action: ${action}`));
                }, 15000);
                
                const originalCallback = window[callbackName];
                window[callbackName] = function(data) {
                    clearTimeout(timeout);
                    originalCallback(data);
                };
                
                document.head.appendChild(script);
            });
        }

        async function testAPIConnection() {
            console.log('Testing API connection with JSONP...');
            showMessage('🔧 Testing API connection...', 'info');
            
            try {
                const result = await makeJSONPRequest('test');
                
                if (result.status === 'success') {
                    showMessage('✅ API connection successful!', 'success');
                    console.log('API test result:', result);
                    return true;
                } else {
                    throw new Error(result.error || 'API test failed');
                }
                
            } catch (error) {
                console.error('API test failed:', error);
                showMessage(`❌ API connection failed: ${error.message}`, 'error');
                return false;
            }
        }

        // ====================
        // UI HELPER FUNCTIONS
        // ====================

        function showMessage(message, type) {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.innerHTML = `<div class="status-message status-${type}">${message}</div>`;

            setTimeout(() => {
                statusDiv.innerHTML = '';
            }, 5000);
        }

        function showLoading(show) {
            const loading = document.getElementById('loadingIndicator');
            const grid = document.getElementById('investorGrid');
            
            if (show) {
                loading.style.display = 'block';
                grid.style.display = 'none';
            } else {
                loading.style.display = 'none';
                grid.style.display = 'grid';
            }
        }

        function hideSecurityAlert() {
            document.getElementById('securityAlert').style.display = 'none';
        }

        // ====================
        // AUTHENTICATION FUNCTIONS
        // ====================

        async function login() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            const errorDiv = document.getElementById('loginError');
            const loginButton = document.getElementById('loginButton');
            const loginButtonText = document.getElementById('loginButtonText');

            if (!email || !password) {
                errorDiv.textContent = 'Please enter both email and password';
                return;
            }

            if (!email.includes('@')) {
                errorDiv.textContent = 'Please enter a valid email address';
                return;
            }

            if (loginAttempts >= CONFIG.maxLoginAttempts) {
                errorDiv.textContent = 'Too many login attempts. Please wait 15 minutes.';
                return;
            }

            loginButton.disabled = true;
            loginButton.classList.add('btn-loading');
            loginButtonText.textContent = 'Signing in...';
            errorDiv.textContent = '';

            try {
                loginAttempts++;
                console.log('Attempting JSONP login for:', email);

                const result = await makeJSONPRequest('authenticate', {
                    email: email,
                    password: password
                });
                
                console.log('Login result:', result);
                
                if (result.success && result.user && result.user.active) {
                    currentUser = result.user;
                    currentUser.initials = getInitials(currentUser.name);
                    isAuthenticated = true;
                    loginAttempts = 0;
                    
                    showMainApp();
                    startSessionTimer();
                    showMessage('✅ Login successful!', 'success');
                } else {
                    throw new Error(result.error || 'Invalid credentials or inactive account');
                }
                
            } catch (error) {
                console.error('Login error:', error);
                errorDiv.textContent = error.message;
                
                if (loginAttempts < CONFIG.maxLoginAttempts) {
                    errorDiv.textContent += ` (${CONFIG.maxLoginAttempts - loginAttempts} attempts remaining)`;
                }
            } finally {
                loginButton.disabled = false;
                loginButton.classList.remove('btn-loading');
                loginButtonText.textContent = 'Sign In';
            }
        }

        function logout() {
            isAuthenticated = false;
            currentUser = null;
            clearTimeout(sessionTimer);
            
            document.getElementById('loginModal').style.display = 'flex';
            document.getElementById('mainApp').style.display = 'none';
            
            document.getElementById('loginEmail').value = '';
            document.getElementById('loginPassword').value = '';
            document.getElementById('loginError').textContent = '';
        }

        function showMainApp() {
            document.getElementById('loginModal').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            
            document.getElementById('userName').textContent = currentUser.name;
            document.getElementById('userAvatar').textContent = currentUser.initials;
            document.getElementById('userRole').textContent = `${currentUser.role.charAt(0).toUpperCase() + currentUser.role.slice(1)} • ${currentUser.department}`;
            
            if (currentUser.role === 'admin' || currentUser.role === 'manager') {
                document.getElementById('userMgmtBtn').style.display = 'block';
            }
            
            loadData();
        }

        // ====================
        // SESSION MANAGEMENT
        // ====================

        function startSessionTimer() {
            clearTimeout(sessionTimer);
            sessionTimer = setTimeout(() => {
                showMessage('⚠️ Session expired for security. Please log in again.', 'warning');
                logout();
            }, CONFIG.sessionTimeout);
        }

        function resetSessionTimer() {
            if (isAuthenticated) {
                startSessionTimer();
                updateSessionInfo();
            }
        }

        function updateSessionInfo() {
            const sessionInfo = document.getElementById('sessionInfo');
            if (sessionInfo && isAuthenticated) {
                const timeLeft = Math.round(CONFIG.sessionTimeout / 60000);
                sessionInfo.textContent = `Session expires in ${timeLeft} min`;
            }
        }

        // ====================
        // DATA LOADING FUNCTIONS
        // ====================

        async function loadData() {
            showLoading(true);
            
            try {
                console.log('Loading data from Google Sheets...');
                resetSessionTimer();
                
                const investorsData = await makeJSONPRequest('getInvestors');
                console.log('Investors data received:', investorsData);
                
                if (investorsData.error) {
                    throw new Error(investorsData.error);
                }

                allInvestors = investorsData.investors || [];
                filteredInvestors = [...allInvestors];

                await loadNotes();
                
                populateFilterDropdowns();
                displayInvestors();
                
                showMessage(`✅ Loaded ${allInvestors.length} family offices from Google Sheets!`, 'success');
                
            } catch (error) {
                console.error('Error loading data:', error);
                showMessage(`❌ Error loading data: ${error.message}`, 'error');
                
                document.getElementById('resultsCount').textContent = 'Error loading data';
                document.getElementById('investorGrid').innerHTML = `
                    <div style="grid-column: 1/-1; text-align: center; padding: 40px; background: #f8d7da; border-radius: 12px; border: 1px solid #f5c6cb; color: #721c24;">
                        <h3>Unable to load data from Google Sheets</h3>
                        <p style="margin: 10px 0;">${error.message}</p>
                        <div style="margin-top: 20px;">
                            <button class="btn btn-primary" onclick="loadData()">🔄 Try Again</button>
                        </div>
                    </div>
                `;
            }
            
            showLoading(false);
        }

        async function loadNotes() {
            console.log('Loading notes from Google Sheets...');
            try {
                const notesResponse = await makeJSONPRequest('getNotes');
                console.log('Notes data received:', notesResponse);
                
                if (notesResponse.error) {
                    console.warn('Notes loading failed:', notesResponse.error);
                    notesData = [];
                } else {
                    notesData = notesResponse.notes || [];
                }
                
                console.log(`Loaded ${notesData.length} notes from Google Sheets`);
                
            } catch (error) {
                console.error('Error loading notes:', error);
                notesData = [];
            }
        }

        function refreshData() {
            loadData();
        }

        // ====================
        // SEARCH AND FILTER FUNCTIONS
        // ====================

        function populateFilterDropdowns() {
            const countries = [...new Set(allInvestors.map(inv => inv.maincountry || inv.country).filter(Boolean))].sort();
            populateSelect('searchCountry', countries);

            const industries = [...new Set(allInvestors.flatMap(inv => {
                const industryField = inv.industries || inv.industry || '';
                return industryField.toString().split(/[|,]/).map(i => i.trim()).filter(Boolean);
            }))].sort();
            populateSelect('searchIndustry', industries);

            const stages = [...new Set(allInvestors.flatMap(inv => {
                const stageField = inv.stages || inv.stage || '';
                return stageField.toString().split(',').map(s => s.trim()).filter(Boolean);
            }))].sort();
            populateSelect('searchStage', stages);

            const owners = [...new Set(allInvestors.map(inv => inv.msauser || inv.owner).filter(Boolean))].sort();
            populateSelect('searchOwner', owners);

            const dealNames = [...new Set(notesData.map(note => note.dealname || note.dealName).filter(Boolean))].sort();
            populateSelect('searchDeal', dealNames);
        }

        function populateSelect(selectId, options) {
            const select = document.getElementById(selectId);
            const currentValue = select.value;
            const firstOption = select.innerHTML.split('</option>')[0] + '</option>';
            
            select.innerHTML = firstOption + options.map(option => 
                `<option value="${sanitizeInput(option)}">${sanitizeInput(option)}</option>`
            ).join('');
            
            select.value = currentValue;
        }

        function searchInvestors() {
            const name = document.getElementById('searchName').value.toLowerCase();
            const country = document.getElementById('searchCountry').value;
            const industry = document.getElementById('searchIndustry').value;
            const stage = document.getElementById('searchStage').value;
            const owner = document.getElementById('searchOwner').value;
            const dealName = document.getElementById('searchDeal').value;

            filteredInvestors = allInvestors.filter(investor => {
                const matchesName = !name || (investor.investor || investor.name || '').toLowerCase().includes(name);
                const matchesCountry = !country || (investor.maincountry || investor.country) === country;
                const matchesIndustry = !industry || (investor.industries || investor.industry || '').includes(industry);
                const matchesStage = !stage || (investor.stages || investor.stage || '').includes(stage);
                const matchesOwner = !owner || (investor.msauser || investor.owner) === owner;
                
                let matchesDeal = true;
                if (dealName) {
                    const contactNotes = notesData.filter(note => 
                        (note.contactid === generateContactId(investor) || note.contact_id === generateContactId(investor)) && 
                        (note.dealname === dealName || note.dealName === dealName)
                    );
                    matchesDeal = contactNotes.length > 0;
                }

                return matchesName && matchesCountry && matchesIndustry && matchesStage && matchesOwner && matchesDeal;
            });

            currentPage = 1;
            displayInvestors();
            resetSessionTimer();
        }

        function clearSearch() {
            document.getElementById('searchName').value = '';
            document.getElementById('searchCountry').value = '';
            document.getElementById('searchIndustry').value = '';
            document.getElementById('searchStage').value = '';
            document.getElementById('searchOwner').value = '';
            document.getElementById('searchDeal').value = '';

            filteredInvestors = [...allInvestors];
            currentPage = 1;
            displayInvestors();
        }

        // ====================
        // PAGINATION FUNCTIONS
        // ====================

        function changePageSize() {
            const newPageSize = parseInt(document.getElementById('pageSize').value);
            pageSize = newPageSize;
            localStorage.setItem('crmPageSize', newPageSize);
            currentPage = 1;
            displayInvestors();
        }

        function goToPage(page) {
            const totalPages = Math.ceil(filteredInvestors.length / pageSize);
            
            if (page === 'last') {
                currentPage = totalPages;
            } else {
                currentPage = Math.max(1, Math.min(page, totalPages));
            }
            
            displayInvestors();
            document.querySelector('.results-section').scrollIntoView({ behavior: 'smooth' });
        }

        function previousPage() {
            if (currentPage > 1) {
                currentPage--;
                displayInvestors();
                document.querySelector('.results-section').scrollIntoView({ behavior: 'smooth' });
            }
        }

        function nextPage() {
            const totalPages = Math.ceil(filteredInvestors.length / pageSize);
            if (currentPage < totalPages) {
                currentPage++;
                displayInvestors();
                document.querySelector('.results-section').scrollIntoView({ behavior: 'smooth' });
            }
        }

        function sortInvestors(type) {
            document.querySelectorAll('.sort-button').forEach(btn => btn.classList.remove('active'));
            
            if (type === 'alpha') {
                document.getElementById('sortAlpha').classList.add('active');
                
                if (sortOrder === 'alpha') {
                    sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
                } else {
                    sortDirection = 'asc';
                }
                sortOrder = 'alpha';
                
                document.getElementById('sortAlpha').innerHTML = sortDirection === 'asc' ? 'A-Z ↓' : 'Z-A ↑';
                
                filteredInvestors.sort((a, b) => {
                    const nameA = (a.investor || a.name || '').toLowerCase();
                    const nameB = (b.investor || b.name || '').toLowerCase();
                    
                    if (sortDirection === 'asc') {
                        return nameA.localeCompare(nameB);
                    } else {
                        return nameB.localeCompare(nameA);
                    }
                });
            } else {
                document.getElementById('sortDefault').classList.add('active');
                sortOrder = 'default';
                filteredInvestors = allInvestors.filter(inv => filteredInvestors.includes(inv));
            }
            
            currentPage = 1;
            displayInvestors();
        }

        function updatePaginationControls() {
            const totalItems = filteredInvestors.length;
            const totalPages = Math.ceil(totalItems / pageSize);
            const startIndex = (currentPage - 1) * pageSize;
            const endIndex = Math.min(startIndex + pageSize, totalItems);
            
            document.getElementById('pageSize').value = pageSize;
            
            const paginationInfo = document.getElementById('paginationInfo');
            if (totalItems === 0) {
                paginationInfo.textContent = 'No results found';
            } else {
                if (window.innerWidth < 768) {
                    paginationInfo.textContent = `${startIndex + 1}-${endIndex} of ${totalItems}`;
                } else {
                    paginationInfo.textContent = `Showing ${startIndex + 1}-${endIndex} of ${totalItems} results`;
                }
            }
            
            const firstBtn = document.querySelector('button[onclick="goToPage(1)"]');
            const prevBtn = document.querySelector('button[onclick="previousPage()"]');
            const nextBtn = document.querySelector('button[onclick="nextPage()"]');
            const lastBtn = document.querySelector('button[onclick="goToPage(\'last\')"]');
            
            if (firstBtn) firstBtn.disabled = currentPage === 1;
            if (prevBtn) prevBtn.disabled = currentPage === 1;
            if (nextBtn) nextBtn.disabled = currentPage === totalPages || totalPages === 0;
            if (lastBtn) lastBtn.disabled = currentPage === totalPages || totalPages === 0;
            
            const pageNumbers = document.getElementById('pageNumbers');
            if (pageNumbers) {
                let pageNumbersHtml = '';
                
                if (totalPages <= 7) {
                    for (let i = 1; i <= totalPages; i++) {
                        pageNumbersHtml += createPageButton(i);
                    }
                } else {
                    if (currentPage <= 4) {
                        for (let i = 1; i <= 5; i++) {
                            pageNumbersHtml += createPageButton(i);
                        }
                        pageNumbersHtml += '<span style="padding: 0 10px;">...</span>';
                        pageNumbersHtml += createPageButton(totalPages);
                    } else if (currentPage >= totalPages - 3) {
                        pageNumbersHtml += createPageButton(1);
                        pageNumbersHtml += '<span style="padding: 0 10px;">...</span>';
                        for (let i = totalPages - 4; i <= totalPages; i++) {
                            pageNumbersHtml += createPageButton(i);
                        }
                    } else {
                        pageNumbersHtml += createPageButton(1);
                        pageNumbersHtml += '<span style="padding: 0 10px;">...</span>';
                        for (let i = currentPage - 1; i <= currentPage + 1; i++) {
                            pageNumbersHtml += createPageButton(i);
                        }
                        pageNumbersHtml += '<span style="padding: 0 10px;">...</span>';
                        pageNumbersHtml += createPageButton(totalPages);
                    }
                }
                
                pageNumbers.innerHTML = pageNumbersHtml;
            }
            
            const bottomPagination = document.getElementById('bottomPagination');
            if (bottomPagination) {
                bottomPagination.innerHTML = document.getElementById('topPagination').innerHTML;
            }
        }

        function createPageButton(pageNum) {
            const isActive = pageNum === currentPage;
            return `<button onclick="goToPage(${pageNum})" ${isActive ? 'disabled' : ''} style="
                padding: 8px 12px;
                border: 1px solid ${isActive ? '#282828' : '#dee2e6'};
                background: ${isActive ? '#282828' : 'white'};
                color: ${isActive ? 'white' : '#333'};
                border-radius: 6px;
                cursor: ${isActive ? 'default' : 'pointer'};
                margin: 0 2px;
                font-size: 0.9em;
            ">${pageNum}</button>`;
        }

        // ====================
        // DISPLAY FUNCTIONS
        // ====================

        function displayInvestors() {
            const grid = document.getElementById('investorGrid');
            const count = document.getElementById('resultsCount');

            const totalItems = filteredInvestors.length;
            const startIndex = (currentPage - 1) * pageSize;
            const endIndex = Math.min(startIndex + pageSize, totalItems);
            const paginatedInvestors = filteredInvestors.slice(startIndex, endIndex);

            count.textContent = `Found ${totalItems} family office${totalItems !== 1 ? 's' : ''}`;

            if (totalItems === 0) {
                grid.innerHTML = `
                    <div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #666;">
                        <h3>No family offices found</h3>
                        <p>Try adjusting your search criteria</p>
                        <button class="btn btn-secondary" onclick="clearSearch()" style="margin-top: 15px;">Clear Search</button>
                    </div>
                `;
                updatePaginationControls();
                return;
            }

            grid.innerHTML = paginatedInvestors.map((investor, index) => {
                const contactId = generateContactId(investor);
                const contactNotes = notesData.filter(note => note.contactid === contactId || note.contact_id === contactId);
                const notesCount = contactNotes.length;

                const name = sanitizeInput(investor.investor || investor.name || `Unnamed Office ${startIndex + index + 1}`);
                const website = sanitizeInput(investor.domain || investor.website || '');
                const country = sanitizeInput(investor.maincountry || investor.country || '');
                const city = sanitizeInput(investor.maincity || investor.city || '');
                const overview = sanitizeInput(investor.overview || investor.description || '');
                const fundrestrictions = sanitizeInput(investor.fundrestrictions || investor.restrictions || '');
                const industries = sanitizeInput(investor.industries || investor.industry || '');
                const stages = sanitizeInput(investor.stages || investor.stage || '');
                const owner = sanitizeInput(investor.msauser || investor.owner || '');
                
                const contact1name = sanitizeInput((investor.contact1firstname || '') + ' ' + (investor.contact1lastname || '')).trim();
                const contact1title = sanitizeInput(investor.contact1title || '');
                const contact1email = sanitizeInput(investor.contact1email || '');
                const contact1linkedin = sanitizeInput(investor.contact1linkedin || '');
                
                const contact2name = sanitizeInput((investor.contact2firstname || '') + ' ' + (investor.contact2lastname || '')).trim();
                const contact2title = sanitizeInput(investor.contact2title || '');
                const contact2email = sanitizeInput(investor.contact2email || '');
                const contact2linkedin = sanitizeInput(investor.contact2linkedin || '');

                const industriesList = industries.split(/[|,]/).map(i => i.trim()).filter(i => i);
                const stagesList = stages.split(',').map(s => s.trim()).filter(s => s);

                return `
                    <div class="investor-card">
                        <button class="notes-button" onclick="openNotesModal('${contactId}', '${name.replace(/'/g, "\\'")}')">
                            📝 Notes
                            ${notesCount > 0 ? `<span class="notes-count">${notesCount}</span>` : ''}
                        </button>
                        
                        <div class="investor-name">${name}</div>
                        
                        ${website ? `
                            <div class="investor-detail">
                                <strong>🌐 Website:</strong>
                                <span><a href="${website.startsWith('http') ? website : 'https://' + website}" target="_blank" rel="noopener noreferrer">${website}</a></span>
                            </div>
                        ` : ''}
                        
                        <div class="investor-detail">
                            <strong>📍 Location:</strong>
                            <span>${[city, country].filter(Boolean).join(', ') || 'Not specified'}</span>
                        </div>
                        
                        ${owner ? `
                            <div class="investor-detail">
                                <strong>👤 Owner:</strong>
                                <span>${owner}</span>
                            </div>
                        ` : ''}
                        
                        ${overview ? `
                            <div class="investor-detail">
                                <strong>📝 Overview:</strong>
                                <span>${overview}</span>
                            </div>
                        ` : ''}
                        
                        ${fundrestrictions ? `
                            <div class="investor-detail">
                                <strong>⚠️ Restrictions:</strong>
                                <span>${fundrestrictions}</span>
                            </div>
                        ` : ''}
                        
                        ${(industriesList.length > 0 || stagesList.length > 0) ? `
                            <div class="tags">
                                ${industriesList.slice(0, 3).map(industry => `<div class="tag">${industry}</div>`).join('')}
                                ${stagesList.slice(0, 2).map(stage => `<div class="tag">${stage}</div>`).join('')}
                            </div>
                        ` : ''}
                        
                        ${(contact1name || contact2name) ? `
                            <div class="contacts-section">
                                <strong style="color: #495057; font-size: 0.9em;">👥 Contacts:</strong>
                                <div class="contacts-grid">
                                    ${contact1name ? `
                                        <div class="contact">
                                            <div class="contact-name">${contact1name}</div>
                                            ${contact1title ? `<div class="contact-detail">${contact1title}</div>` : ''}
                                            ${contact1email ? `<div class="contact-detail">📧 ${contact1email}</div>` : ''}
                                            ${contact1linkedin ? `<div class="contact-detail"><a href="${contact1linkedin}" target="_blank" rel="noopener noreferrer">🔗 LinkedIn</a></div>` : ''}
                                        </div>
                                    ` : ''}
                                    ${contact2name ? `
                                        <div class="contact">
                                            <div class="contact-name">${contact2name}</div>
                                            ${contact2title ? `<div class="contact-detail">${contact2title}</div>` : ''}
                                            ${contact2email ? `<div class="contact-detail">📧 ${contact2email}</div>` : ''}
                                            ${contact2linkedin ? `<div class="contact-detail"><a href="${contact2linkedin}" target="_blank" rel="noopener noreferrer">🔗 LinkedIn</a></div>` : ''}
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');

            updatePaginationControls();
        }

        // ====================
        // NOTES MANAGEMENT
        // ====================

        function openNotesModal(contactId, contactName) {
            currentContactId = contactId;
            
            document.getElementById('notesModalTitle').textContent = `Notes for ${contactName}`;
            document.getElementById('notesModalSubtitle').textContent = `Manage your interactions and follow-ups with ${contactName}`;
            
            document.getElementById('noteDate').value = new Date().toISOString().split('T')[0];
            
            document.getElementById('noteType').value = 'call';
            document.getElementById('dealName').value = '';
            document.getElementById('dealNameInput').value = '';
            document.getElementById('dealNameInput').style.display = 'none';
            document.getElementById('noteContent').value = '';
            
            populateDealsDropdown();
            displayContactNotes(contactId);
            
            document.getElementById('notesModal').classList.add('show');
            resetSessionTimer();
        }

        function closeNotesModal() {
            document.getElementById('notesModal').classList.remove('show');
            currentContactId = null;
        }

        function handleDealSelection() {
            const dealSelect = document.getElementById('dealName');
            const dealInput = document.getElementById('dealNameInput');
            
            if (dealSelect.value === '__create_new__') {
                dealInput.style.display = 'block';
                dealInput.focus();
            } else {
                dealInput.style.display = 'none';
                dealInput.value = '';
            }
        }

        function populateDealsDropdown() {
            const dealSelect = document.getElementById('dealName');
            const existingDeals = [...new Set(notesData.map(note => note.dealname || note.dealName).filter(Boolean))].sort();
            
            dealSelect.innerHTML = `
                <option value="">Select existing deal or create new...</option>
                <option value="__create_new__">➕ Create New Deal</option>
                ${existingDeals.map(deal => `<option value="${sanitizeInput(deal)}">${sanitizeInput(deal)}</option>`).join('')}
            `;
        }

        function displayContactNotes(contactId) {
            const contactNotes = notesData.filter(note => 
                note.contactid === contactId || note.contact_id === contactId
            );
            const notesList = document.getElementById('notesList');

            if (contactNotes.length === 0) {
                notesList.innerHTML = `
                    <div class="empty-notes">
                        <h4>📝 No notes yet</h4>
                        <p>Start by adding your first note above</p>
                    </div>
                `;
                return;
            }

            contactNotes.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            notesList.innerHTML = contactNotes.map(note => {
                const noteTypeIcons = {
                    call: '📞',
                    email: '📧',
                    meeting: '🤝',
                    other: '📋'
                };

                const formattedDate = new Date(note.date).toLocaleDateString();
                const formattedTime = new Date(note.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

                return `
                    <div class="note-item">
                        <div class="note-header">
                            <div class="note-meta">
                                <span class="note-type">${noteTypeIcons[note.notetype || note.type] || '📋'} ${(note.notetype || note.type || 'Note').charAt(0).toUpperCase() + (note.notetype || note.type || 'note').slice(1)}</span>
                                ${(note.dealname || note.dealName) ? `<span class="deal-tag">💼 ${sanitizeInput(note.dealname || note.dealName)}</span>` : ''}
                                <span>📅 ${formattedDate}</span>
                                <span>🕒 ${formattedTime}</span>
                                <span>👤 ${sanitizeInput(note.user || 'Unknown')}</span>
                            </div>
                        </div>
                        <div class="note-content">${sanitizeInput(note.notecontent || note.content || '')}</div>
                    </div>
                `;
            }).join('');
        }

        async function addNote() {
            const noteType = document.getElementById('noteType').value;
            const dealSelect = document.getElementById('dealName');
            const dealInput = document.getElementById('dealNameInput');
            const noteDate = document.getElementById('noteDate').value;
            const noteContent = document.getElementById('noteContent').value.trim();

            let dealName = '';
            if (dealSelect.value === '__create_new__') {
                dealName = dealInput.value.trim();
                if (!dealName) {
                    showMessage('Please enter a new deal name', 'error');
                    return;
                }
            } else {
                dealName = dealSelect.value;
            }

            if (!noteContent) {
                showMessage('Please enter note content', 'error');
                return;
            }

            if (!noteDate) {
                showMessage('Please select a date', 'error');
                return;
            }

            const newNote = {
                id: Date.now(),
                contactId: currentContactId,
                user: currentUser.name,
                type: noteType,
                dealName: dealName,
                content: noteContent,
                date: noteDate,
                timestamp: new Date().toISOString()
            };

            console.log('Adding new note via JSONP:', newNote);

            try {
                const result = await makeJSONPRequest('addNote', {
                    id: newNote.id,
                    contactId: newNote.contactId,
                    user: newNote.user,
                    type: newNote.type,
                    dealName: newNote.dealName,
                    content: newNote.content,
                    date: newNote.date,
                    timestamp: newNote.timestamp
                });

                console.log('Add note result:', result);
                
                if (result.error) {
                    throw new Error(result.error);
                }

                await loadNotes();

                document.getElementById('noteContent').value = '';
                document.getElementById('dealName').value = '';
                document.getElementById('dealNameInput').value = '';
                document.getElementById('dealNameInput').style.display = 'none';

                populateDealsDropdown();
                displayContactNotes(currentContactId);
                populateFilterDropdowns();
                displayInvestors();

                showMessage('✅ Note saved to Google Sheets successfully!', 'success');

            } catch (error) {
                console.error('Error adding note:', error);
                showMessage(`❌ Failed to save note: ${error.message}`, 'error');
            }
        }

        // ====================
        // USER MANAGEMENT
        // ====================

        async function showUserManagement() {
            if (currentUser.role !== 'admin' && currentUser.role !== 'manager') {
                showMessage('❌ Access denied. Admin or Manager role required.', 'error');
                return;
            }
            
            document.getElementById('userManagementModal').classList.add('show');
            showUserList();
            await loadUsers();
            resetSessionTimer();
        }

        function closeUserManagement() {
            document.getElementById('userManagementModal').classList.remove('show');
            editingUserEmail = null;
        }

        async function loadUsers() {
            try {
                console.log('Loading users...');
                const result = await makeJSONPRequest('getUsers');
                
                if (result.error) {
                    throw new Error(result.error);
                }
                
                allUsers = result.users || [];
                filteredUsers = [...allUsers];
                
                console.log(`Loaded ${allUsers.length} users`);
                filterUsers();
                
            } catch (error) {
                console.error('Error loading users:', error);
                showMessage(`❌ Failed to load users: ${error.message}`, 'error');
                allUsers = [];
                filteredUsers = [];
                displayUsers([]);
            }
        }

        function filterUsers() {
            const searchTerm = document.getElementById('userSearch')?.value.toLowerCase() || '';
            const roleFilter = document.getElementById('userFilterRole')?.value || '';
            const statusFilter = document.getElementById('userFilterStatus')?.value || '';
            
            filteredUsers = allUsers.filter(user => {
                const matchesSearch = !searchTerm || 
                    user.name.toLowerCase().includes(searchTerm) ||
                    user.email.toLowerCase().includes(searchTerm) ||
                    user.department.toLowerCase().includes(searchTerm);
                
                const matchesRole = !roleFilter || user.role === roleFilter;
                
                const matchesStatus = !statusFilter || 
                    (statusFilter === 'active' && user.active) ||
                    (statusFilter === 'inactive' && !user.active);
                
                return matchesSearch && matchesRole && matchesStatus;
            });
            
            displayUsers(filteredUsers);
        }

        function displayUsers(users) {
            const usersList = document.getElementById('usersList');
            
            if (!users || users.length === 0) {
                usersList.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <h4>👥 No users found</h4>
                        <p>No users match the current filter criteria</p>
                    </div>
                `;
                return;
            }
            
            const tableHtml = `
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="border-bottom: 2px solid #dee2e6;">
                            <th style="padding: 12px; text-align: left;">Status</th>
                            <th style="padding: 12px; text-align: left;">Name</th>
                            <th style="padding: 12px; text-align: left;">Email</th>
                            <th style="padding: 12px; text-align: left;">Role</th>
                            <th style="padding: 12px; text-align: left;">Department</th>
                            <th style="padding: 12px; text-align: left;">Last Login</th>
                            <th style="padding: 12px; text-align: left;">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${users.map(user => `
                            <tr style="border-bottom: 1px solid #e9ecef;">
                                <td style="padding: 12px;">
                                    <span style="font-size: 1.2em;">${user.active ? '🟢' : '🔴'}</span>
                                </td>
                                <td style="padding: 12px; font-weight: 600;">${sanitizeInput(user.name)}</td>
                                <td style="padding: 12px;">${sanitizeInput(user.email)}</td>
                                <td style="padding: 12px;">
                                    <span style="background: ${getRoleColor(user.role)}; color: white; padding: 4px 8px; border-radius: 12px; font-size: 0.8em;">
                                        ${user.role.charAt(0).toUpperCase() + user.role.slice(1)}
                                    </span>
                                </td>
                                <td style="padding: 12px;">${sanitizeInput(user.department)}</td>
                                <td style="padding: 12px; font-size: 0.9em; color: #666;">
                                    ${user.lastLogin ? new Date(user.lastLogin).toLocaleDateString() : 'Never'}
                                </td>
                                <td style="padding: 12px;">
                                    <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                                        <button class="btn btn-secondary" onclick="editUser('${user.email}')" style="padding: 4px 8px; font-size: 0.8em;">
                                            ✏️ Edit
                                        </button>
                                        ${user.email !== currentUser.email ? `
                                            <button class="btn btn-secondary" onclick="toggleUserStatus('${user.email}', ${user.active})" style="padding: 4px 8px; font-size: 0.8em;">
                                                ${user.active ? '🚫 Deactivate' : '✅ Activate'}
                                            </button>
                                            <button class="btn btn-secondary" onclick="resetUserPassword('${user.email}')" style="padding: 4px 8px; font-size: 0.8em;">
                                                🔑 Reset
                                            </button>
                                        ` : ''}
                                    </div>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            usersList.innerHTML = tableHtml;
        }

        function getRoleColor(role) {
            const colors = {
                admin: '#dc3545',
                manager: '#28a745',
                user: '#6c757d'
            };
            return colors[role] || '#6c757d';
        }

        function showUserList() {
            document.getElementById('userListView').style.display = 'block';
            document.getElementById('userFormView').style.display = 'none';
        }

        function showAddUser() {
            editingUserEmail = null;
            document.getElementById('userFormTitle').textContent = 'Add New User';
            document.getElementById('userFormEmail').disabled = false;
            document.getElementById('passwordSection').style.display = 'block';
            
            // Clear form
            document.getElementById('userFormName').value = '';
            document.getElementById('userFormEmail').value = '';
            document.getElementById('userFormDepartment').value = '';
            document.getElementById('userFormRole').value = 'user';
            document.getElementById('userFormPassword').value = '';
            document.getElementById('userFormActive').checked = true;
            document.getElementById('forcePasswordChange').checked = true;
            
            // Reset password requirements
            document.querySelectorAll('.requirement').forEach(el => {
                el.textContent = '❌ ' + el.textContent.substring(2);
                el.style.color = '#dc3545';
            });
            
            document.getElementById('userPasswordStrength').className = 'password-strength-bar';
            
            document.getElementById('userListView').style.display = 'none';
            document.getElementById('userFormView').style.display = 'block';
        }

        function editUser(email) {
            const user = allUsers.find(u => u.email === email);
            if (!user) {
                showMessage('❌ User not found', 'error');
                return;
            }
            
            editingUserEmail = email;
            document.getElementById('userFormTitle').textContent = `Edit User: ${user.name}`;
            document.getElementById('userFormEmail').disabled = true;
            document.getElementById('passwordSection').style.display = 'none';
            
            // Populate form
            document.getElementById('userFormName').value = user.name;
            document.getElementById('userFormEmail').value = user.email;
            document.getElementById('userFormDepartment').value = user.department;
            document.getElementById('userFormRole').value = user.role;
            document.getElementById('userFormActive').checked = user.active;
            
            document.getElementById('userListView').style.display = 'none';
            document.getElementById('userFormView').style.display = 'block';
        }

        async function saveUser() {
            const name = document.getElementById('userFormName').value.trim();
            const email = document.getElementById('userFormEmail').value.trim();
            const department = document.getElementById('userFormDepartment').value;
            const role = document.getElementById('userFormRole').value;
            const active = document.getElementById('userFormActive').checked;
            const saveButton = document.getElementById('saveUserBtn');
            
            // Validation
            if (!name || !email || !department) {
                showMessage('❌ Please fill in all required fields', 'error');
                return;
            }
            
            if (!editingUserEmail) {
                // New user - validate password
                const password = document.getElementById('userFormPassword').value;
                if (!password) {
                    showMessage('❌ Password is required for new users', 'error');
                    return;
                }
                
                const { score } = validatePasswordStrength(password);
                if (score < 5) {
                    showMessage('❌ Password does not meet all security requirements', 'error');
                    return;
                }
            }
            
            saveButton.disabled = true;
            saveButton.classList.add('btn-loading');
            saveButton.textContent = 'Saving...';
            
            try {
                let result;
                
                if (editingUserEmail) {
                    // Update existing user
                    result = await makeJSONPRequest('updateUser', {
                        email: email,
                        name: name,
                        department: department,
                        role: role,
                        active: active,
                        currentUserEmail: currentUser.email
                    });
                } else {
                    // Add new user
                    const password = document.getElementById('userFormPassword').value;
                    const mustChangePassword = document.getElementById('forcePasswordChange').checked;
                    
                    result = await makeJSONPRequest('addUser', {
                        email: email,
                        password: password,
                        name: name,
                        role: role,
                        department: department,
                        mustChangePassword: mustChangePassword,
                        currentUserEmail: currentUser.email
                    });
                }
                
                if (result.success) {
                    showMessage(`✅ User ${editingUserEmail ? 'updated' : 'added'} successfully!${result.emailSent ? ' Welcome email sent.' : ''}`, 'success');
                    showUserList();
                    await loadUsers();
                } else {
                    throw new Error(result.error);
                }
                
            } catch (error) {
                showMessage(`❌ Failed to save user: ${error.message}`, 'error');
            } finally {
                saveButton.disabled = false;
                saveButton.classList.remove('btn-loading');
                saveButton.textContent = 'Save User';
            }
        }

        async function toggleUserStatus(email, currentStatus) {
            const action = currentStatus ? 'deactivate' : 'activate';
            
            if (!confirm(`Are you sure you want to ${action} this user?`)) {
                return;
            }
            
            try {
                const result = await makeJSONPRequest('updateUser', {
                    email: email,
                    active: !currentStatus,
                    currentUserEmail: currentUser.email
                });
                
                if (result.success) {
                    showMessage(`✅ User ${action}d successfully!`, 'success');
                    await loadUsers();
                } else {
                    throw new Error(result.error);
                }
                
            } catch (error) {
                showMessage(`❌ Failed to ${action} user: ${error.message}`, 'error');
            }
        }

        async function resetUserPassword(email) {
            if (!confirm(`Reset password for ${email}? They will receive a temporary password.`)) {
                return;
            }
            
            try {
                const result = await makeJSONPRequest('resetPassword', {
                    targetEmail: email,
                    adminEmail: currentUser.email
                });
                
                if (result.success) {
                    showMessage(`✅ Password reset successfully!${result.emailSent ? ' Reset email sent to user.' : ''}`, 'success');
                    
                    // Show temporary password only if email failed
                    if (!result.emailSent && result.tempPassword) {
                        const message = `Temporary password for ${email}:\n${result.tempPassword}\n\nPlease share this securely with the user.`;
                        alert(message);
                        
                        // Try to copy to clipboard
                        if (navigator.clipboard) {
                            navigator.clipboard.writeText(result.tempPassword);
                            showMessage('📋 Temporary password copied to clipboard', 'info');
                        }
                    }
                } else {
                    throw new Error(result.error);
                }
                
            } catch (error) {
                showMessage(`❌ Failed to reset password: ${error.message}`, 'error');
            }
        }

        function generatePassword() {
            const length = 16;
            const uppercase = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
            const lowercase = 'abcdefghijklmnopqrstuvwxyz';
            const numbers = '0123456789';
            const special = '!@#$%^&*()_+-=[]{}|;:,.<>?';
            const all = uppercase + lowercase + numbers + special;
            
            let password = '';
            
            // Ensure at least one of each type
            password += uppercase[Math.floor(Math.random() * uppercase.length)];
            password += lowercase[Math.floor(Math.random() * lowercase.length)];
            password += numbers[Math.floor(Math.random() * numbers.length)];
            password += special[Math.floor(Math.random() * special.length)];
            
            // Fill the rest
            for (let i = password.length; i < length; i++) {
                password += all[Math.floor(Math.random() * all.length)];
            }
            
            // Shuffle the password
            password = password.split('').sort(() => Math.random() - 0.5).join('');
            
            // Set the password and trigger validation
            document.getElementById('userFormPassword').value = password;
            checkUserPasswordStrength();
            
            // Copy to clipboard
            if (navigator.clipboard) {
                navigator.clipboard.writeText(password);
                showMessage('📋 Password copied to clipboard', 'info');
            }
        }

        // ====================
        // PASSWORD MANAGEMENT
        // ====================

        function changePassword() {
            console.log('Change password button clicked');
            document.getElementById('changePasswordModal').classList.add('show');
            resetSessionTimer();
        }

        function closeChangePassword() {
            const modal = document.getElementById('changePasswordModal');
            if (modal) {
                modal.classList.remove('show');
                document.getElementById('currentPassword').value = '';
                document.getElementById('newPassword').value = '';
                document.getElementById('confirmPassword').value = '';
                const strengthBar = document.getElementById('passwordStrength');
                if (strengthBar) {
                    strengthBar.className = 'password-strength-bar';
                }
            }
        }

        async function updatePassword() {
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const updateButton = document.getElementById('updatePasswordBtn');
            const logoutOthers = document.getElementById('logoutOthers') ? document.getElementById('logoutOthers').checked : false;

            // Validation
            if (!currentPassword || !newPassword || !confirmPassword) {
                showMessage('❌ Please fill in all password fields', 'error');
                return;
            }

            if (newPassword !== confirmPassword) {
                showMessage('❌ New passwords do not match', 'error');
                return;
            }

            if (currentPassword === newPassword) {
                showMessage('❌ New password must be different from current password', 'error');
                return;
            }

            const passwordValidation = validatePasswordStrength(newPassword);
            if (passwordValidation.score < 5) {
                showMessage('❌ New password does not meet all security requirements', 'error');
                return;
            }

            updateButton.disabled = true;
            updateButton.classList.add('btn-loading');
            updateButton.textContent = 'Updating...';

            try {
                const result = await makeJSONPRequest('changePasswordEnhanced', {
                    email: currentUser.email,
                    currentPassword: currentPassword,
                    newPassword: newPassword,
                    logoutOthers: logoutOthers
                });

                if (result.success) {
                    closeChangePassword();
                    showMessage('✅ Password updated successfully!', 'success');
                    
                    // Clear password fields
                    document.getElementById('currentPassword').value = '';
                    document.getElementById('newPassword').value = '';
                    document.getElementById('confirmPassword').value = '';
                    
                    if (result.logoutOthers) {
                        setTimeout(() => {
                            showMessage('🔐 Logging out from other sessions...', 'info');
                        }, 2000);
                    }
                } else {
                    showMessage(`❌ ${result.error}`, 'error');
                    if (result.details) {
                        console.error('Password validation details:', result.details);
                    }
                }

            } catch (error) {
                showMessage(`❌ Failed to update password: ${error.message}`, 'error');
            } finally {
                updateButton.disabled = false;
                updateButton.classList.remove('btn-loading');
                updateButton.textContent = '🔐 Update Password';
            }
        }

        function validatePasswordStrength(password) {
            const requirements = {
                length: password.length >= 12,
                uppercase: /[A-Z]/.test(password),
                lowercase: /[a-z]/.test(password),
                number: /\d/.test(password),
                special: /[!@#$%^&*(),.?":{}|<>]/.test(password)
            };
            
            const score = Object.values(requirements).filter(Boolean).length;
            
            // Update visual requirements if on password change modal
            updatePasswordRequirements(requirements);
            
            return { requirements, score };
        }

        function updatePasswordRequirements(requirements) {
            const reqElements = document.querySelectorAll('.requirement');
            reqElements.forEach(el => {
                const req = el.getAttribute('data-req');
                if (requirements[req]) {
                    el.textContent = '✅ ' + el.textContent.substring(2);
                    el.style.color = '#28a745';
                } else {
                    el.textContent = '❌ ' + el.textContent.substring(2);
                    el.style.color = '#dc3545';
                }
            });
        }

        function checkPasswordStrength() {
            const password = document.getElementById('newPassword').value;
            const strengthBar = document.getElementById('passwordStrength');
            const confirmMatch = document.getElementById('confirmMatch');
            
            if (!password) {
                strengthBar.className = 'password-strength-bar';
                updatePasswordRequirements({
                    length: false,
                    uppercase: false,
                    lowercase: false,
                    number: false,
                    special: false
                });
                return;
            }
            
            const { score, requirements } = validatePasswordStrength(password);
            
            strengthBar.className = 'password-strength-bar ';
            if (score < 2) strengthBar.className += 'strength-weak';
            else if (score < 3) strengthBar.className += 'strength-fair';
            else if (score < 5) strengthBar.className += 'strength-good';
            else strengthBar.className += 'strength-strong';
            
            // Check if passwords match
            const confirmPassword = document.getElementById('confirmPassword').value;
            if (confirmPassword && confirmMatch) {
                if (password === confirmPassword) {
                    confirmMatch.textContent = '✅ Passwords match';
                    confirmMatch.style.color = '#28a745';
                } else {
                    confirmMatch.textContent = '❌ Passwords do not match';
                    confirmMatch.style.color = '#dc3545';
                }
            }
        }

        function checkPasswordMatch() {
            const password = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const confirmMatch = document.getElementById('confirmMatch');
            
            if (!confirmPassword) {
                confirmMatch.textContent = '';
                return;
            }
            
            if (password === confirmPassword) {
                confirmMatch.textContent = '✅ Passwords match';
                confirmMatch.style.color = '#28a745';
            } else {
                confirmMatch.textContent = '❌ Passwords do not match';
                confirmMatch.style.color = '#dc3545';
            }
        }

        function checkUserPasswordStrength() {
            const password = document.getElementById('userFormPassword').value;
            const strengthBar = document.getElementById('userPasswordStrength');
            
            if (!password) {
                strengthBar.className = 'password-strength-bar';
                document.querySelectorAll('.requirement').forEach(el => {
                    el.textContent = '❌ ' + el.textContent.substring(2);
                    el.style.color = '#dc3545';
                });
                return;
            }
            
            const { score, requirements } = validatePasswordStrength(password);
            
            strengthBar.className = 'password-strength-bar ';
            if (score < 2) strengthBar.className += 'strength-weak';
            else if (score < 3) strengthBar.className += 'strength-fair';
            else if (score < 5) strengthBar.className += 'strength-good';
            else strengthBar.className += 'strength-strong';
        }

        function togglePasswordVisibility(fieldId) {
            const field = document.getElementById(fieldId);
            const button = event.target;
            
            if (field.type === 'password') {
                field.type = 'text';
                button.textContent = '👁‍🗨';
            } else {
                field.type = 'password';
                button.textContent = '👁';
            }
        }

        // ====================
        // EVENT LISTENERS
        // ====================

        document.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                if (e.target.closest('.login-form')) {
                    login();
                } else if (e.target.closest('.search-section')) {
                    searchInvestors();
                }
            }
        });

        // Reset session timer on user activity
        document.addEventListener('click', resetSessionTimer);
        document.addEventListener('keypress', resetSessionTimer);

        // Close modals when clicking outside
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('notes-modal')) {
                if (e.target.id === 'notesModal') closeNotesModal();
                if (e.target.id === 'changePasswordModal') closeChangePassword();
                if (e.target.id === 'userManagementModal') closeUserManagement();
            }
        });

        // ====================
        // INITIALIZATION
        // ====================

        document.addEventListener('DOMContentLoaded', function() {
            console.log('🔐 Secure Family Office CRM Initialized');
            
            if (!CONFIG.apiUrl) {
                alert('Configuration error: API URL not defined');
                return;
            }
            
            // Show login modal
            document.getElementById('loginModal').style.display = 'flex';
            
            // Set saved page size
            const savedPageSize = localStorage.getItem('crmPageSize');
            if (savedPageSize) {
                pageSize = parseInt(savedPageSize);
            }
        });
    </script>
</body>
</html>